<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>0CCh Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="0CCh Blog">
<meta property="og:url" content="http://0cch.com/page/2/index.html">
<meta property="og:site_name" content="0CCh Blog">
<meta property="og:locale">
<meta property="article:author" content="0CCh">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="0CCh Blog" type="application/atom+xml">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  
<link rel="stylesheet" href="/css/styles.css">

  

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="/custom_css_source.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li>
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">0CCh Blog</h1>
  
</div>

    <div class="row">
        <div class="col-sm-8 blog-main">
          
  
    <article id="post-metaprogramming-overview" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/20/metaprogramming-overview/">初探C++模板元编程</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/10/20/metaprogramming-overview/" class="article-date"><time datetime="2019-10-20T12:38:15.000Z" itemprop="datePublished">2019-10-20</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CPP/">CPP</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>C++模板元编程，通常来说是指利用模板控制编译器产生临时源代码的技术。该临时源代码可以和以后代码共同编译为可执行程序。由于模板元编程控制的是编译器，所以这个过程是在编译期进行，对于代码运行期的状态没有影响。</p>
<p>使用C++模板元编程编写的程序我们可以称之为模板元程序，最简单的模板元程序我们可以写成这样：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">using</span> mytype = <span class="keyword">int</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;std::is_same&lt;mytype, int&gt;::value = &quot;</span></span><br><span class="line">            &lt;&lt; <span class="built_in">std</span>::is_same&lt;mytype, <span class="keyword">int</span>&gt;::value &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的代码中<code>std::is_same&lt;mytype, int&gt;::value</code>是典型的模板元程序代码，编译器会在编译期对这句代码进行计算，最终产生以下临时代码：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;std::is_same&lt;mytype, int&gt;::value = &quot;</span></span><br><span class="line">            &lt;&lt; <span class="number">1</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<p>进一步可以看出，由于<code>std::is_same&lt;mytype, int&gt;::value</code>在编译期已经得出结果，所以它并不会对程序的运行产生任何副作用。</p>
<p>解释到这里，我想读者应该对C++模板元编程和模板元程序有了一个大概的理解。实际上，在我刚刚接触到模板元程序的时候，最疑惑的问题就是它为什么叫做元程序（metaprogram）。经过一番研究后发现，meta起源于希腊语，有after和beyond的含义，作为前缀通常用于表达更高抽象水平的描述。比如在解释数据库元数据（MetaData）时，我们说它是定义数据的数据。而联想到元程序，同样也可以理解为定义程序的程序。熟悉编写编译器的读者应该会接触到flex和bison（或者lex和yacc）。它们是一对词法和语法的解析器生成器，我们可以通过定义词法和语法规则让它们生成出相当完善的词法和语法的解析器源代码，所以flex和bison就是一对最典型的元程序。</p>
<h2 id="最早的C-模板元程序"><a href="#最早的C-模板元程序" class="headerlink" title="最早的C++模板元程序"></a>最早的C++模板元程序</h2><p>1994年Erwin Unruh在C++委员会上提交了下面这份代码：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Prime number computation by Erwin Unruh</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span> i&gt; <span class="class"><span class="keyword">struct</span> <span class="title">D</span> &#123;</span> D(<span class="keyword">void</span>*); <span class="function"><span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span></span>; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span> p, <span class="keyword">int</span> i&gt; <span class="class"><span class="keyword">struct</span> <span class="title">is_prime</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span> prim = (p%i) &amp;&amp; is_prime&lt;(i &gt; <span class="number">2</span> ? p : <span class="number">0</span>), i <span class="number">-1</span>&gt; :: prim &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt; <span class="keyword">int</span> i &gt; <span class="class"><span class="keyword">struct</span> <span class="title">Prime_print</span> &#123;</span></span><br><span class="line">    Prime_print&lt;i<span class="number">-1</span>&gt; a;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span> prim = is_prime&lt;i, i<span class="number">-1</span>&gt;::prim &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; D&lt;i&gt; d = prim; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">is_prime</span>&lt;</span><span class="number">0</span>,<span class="number">0</span>&gt; &#123; <span class="class"><span class="keyword">enum</span> &#123;</span>prim=<span class="number">1</span>&#125;; &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">is_prime</span>&lt;</span><span class="number">0</span>,<span class="number">1</span>&gt; &#123; <span class="class"><span class="keyword">enum</span> &#123;</span>prim=<span class="number">1</span>&#125;; &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Prime_print</span>&lt;</span><span class="number">2</span>&gt; &#123; <span class="class"><span class="keyword">enum</span> &#123;</span>prim = <span class="number">1</span>&#125;; <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; D&lt;<span class="number">2</span>&gt; d = prim; &#125; &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">main () &#123;</span><br><span class="line">    Prime_print&lt;LAST&gt; a;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>从类模板命名上看，它似乎是一份打印质数的代码。但是请注意，这份代码在现在看来并不符合当前C++的语法规范，所以是无法通过编译的。实际上，当时Erwin Unruh使用的是一款叫做Metaware Compiler的编译器编译的上述代码，虽然仍然无法通过编译，但是却能输出一些有趣的信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MetaWare High C&#x2F;C++ Compiler R2.6</span><br><span class="line">(c) Copyright 1987-94, MetaWare Incorporated</span><br><span class="line">E &quot;primes.cpp&quot;,L16&#x2F;C63(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;2&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br><span class="line">-- Detected during instantiation of Prime_print&lt;30&gt; at &quot;primes.cpp&quot;,L21&#x2F;C5:</span><br><span class="line">E &quot;primes.cpp&quot;,L11&#x2F;C25(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;3&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br><span class="line">-- Detected during instantiation of Prime_print&lt;30&gt; at &quot;primes.cpp&quot;,L21&#x2F;C5:</span><br><span class="line">E &quot;primes.cpp&quot;,L11&#x2F;C25(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;5&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br><span class="line">-- Detected during instantiation of Prime_print&lt;30&gt; at &quot;primes.cpp&quot;,L21&#x2F;C5:</span><br><span class="line">E &quot;primes.cpp&quot;,L11&#x2F;C25(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;7&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br><span class="line">-- Detected during instantiation of Prime_print&lt;30&gt; at &quot;primes.cpp&quot;,L21&#x2F;C5:</span><br><span class="line">E &quot;primes.cpp&quot;,L11&#x2F;C25(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;11&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br><span class="line">-- Detected during instantiation of Prime_print&lt;30&gt; at &quot;primes.cpp&quot;,L21&#x2F;C5:</span><br><span class="line">E &quot;primes.cpp&quot;,L11&#x2F;C25(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;13&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br><span class="line">-- Detected during instantiation of Prime_print&lt;30&gt; at &quot;primes.cpp&quot;,L21&#x2F;C5:</span><br><span class="line">E &quot;primes.cpp&quot;,L11&#x2F;C25(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;17&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br><span class="line">-- Detected during instantiation of Prime_print&lt;30&gt; at &quot;primes.cpp&quot;,L21&#x2F;C5:</span><br><span class="line">E &quot;primes.cpp&quot;,L11&#x2F;C25(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;19&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br><span class="line">-- Detected during instantiation of Prime_print&lt;30&gt; at &quot;primes.cpp&quot;,L21&#x2F;C5:</span><br><span class="line">E &quot;primes.cpp&quot;,L11&#x2F;C25(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;23&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br><span class="line">-- Detected during instantiation of Prime_print&lt;30&gt; at &quot;primes.cpp&quot;,L21&#x2F;C5:</span><br><span class="line">E &quot;primes.cpp&quot;,L11&#x2F;C25(#416):   prim</span><br><span class="line">|    Type &#96;enum&#123;&#125;´ can´t be converted to txpe &#96;D&lt;29&gt;´ (&quot;primes.cpp&quot;,L2&#x2F;C25).</span><br></pre></td></tr></table></figure>
<p>观察上面这份编译器输出的错误信息，我们发现每条错误信息都给出了一个质数，例如<code>D&lt;2&gt;</code>、<code>D&lt;3&gt;</code>、<code>D&lt;4&gt;</code>等等，这说明编译器在编译阶段已经开始了对模板的计算。在1994年之后，Erwin Unruh发现上述代码已经不能被新语法所支持，所以在2002年发布了新代码：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Prime number computation by Erwin Unruh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span> i&gt; <span class="class"><span class="keyword">struct</span> <span class="title">D</span> &#123;</span> D(<span class="keyword">void</span>*); <span class="function"><span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span></span>; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span> p, <span class="keyword">int</span> i&gt; <span class="class"><span class="keyword">struct</span> <span class="title">is_prime</span> &#123;</span></span><br><span class="line"> <span class="class"><span class="keyword">enum</span> &#123;</span> prim = (p==<span class="number">2</span>) || (p%i) &amp;&amp; is_prime&lt;(i&gt;<span class="number">2</span>?p:<span class="number">0</span>), i<span class="number">-1</span>&gt; :: prim &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span> i&gt; <span class="class"><span class="keyword">struct</span> <span class="title">Prime_print</span> &#123;</span></span><br><span class="line"> Prime_print&lt;i<span class="number">-1</span>&gt; a;</span><br><span class="line"> <span class="class"><span class="keyword">enum</span> &#123;</span> prim = is_prime&lt;i, i<span class="number">-1</span>&gt;::prim &#125;;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; D&lt;i&gt; d = prim ? <span class="number">1</span> : <span class="number">0</span>; a.f();&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; <span class="class"><span class="keyword">struct</span> <span class="title">is_prime</span>&lt;</span><span class="number">0</span>,<span class="number">0</span>&gt; &#123; <span class="class"><span class="keyword">enum</span> &#123;</span>prim=<span class="number">1</span>&#125;; &#125;;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; <span class="class"><span class="keyword">struct</span> <span class="title">is_prime</span>&lt;</span><span class="number">0</span>,<span class="number">1</span>&gt; &#123; <span class="class"><span class="keyword">enum</span> &#123;</span>prim=<span class="number">1</span>&#125;; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; <span class="class"><span class="keyword">struct</span> <span class="title">Prime_print</span>&lt;</span><span class="number">1</span>&gt; &#123;</span><br><span class="line"> <span class="class"><span class="keyword">enum</span> &#123;</span>prim=<span class="number">0</span>&#125;;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; D&lt;<span class="number">1</span>&gt; d = prim ? <span class="number">1</span> : <span class="number">0</span>; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST 18</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line"> Prime_print&lt;LAST&gt; a;</span><br><span class="line"> a.f();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这份代码可以用较老版本的GCC编译，比如GCC 4.1，同样的它会让编译器计算并打印出关于质数的错误信息（由于错误信息过多影响阅读，所以这里省略了无用部分，想看完整错误信息的读者可以自己尝试编译上述代码。）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;source&gt;:12: error:   initializing argument 1 of &#39;D&lt;i&gt;::D(void*) [with int i &#x3D; 17]&#39;</span><br><span class="line">...</span><br><span class="line">&lt;source&gt;:12: error:   initializing argument 1 of &#39;D&lt;i&gt;::D(void*) [with int i &#x3D; 13]&#39;</span><br><span class="line">...</span><br><span class="line">&lt;source&gt;:12: error:   initializing argument 1 of &#39;D&lt;i&gt;::D(void*) [with int i &#x3D; 11]&#39;</span><br><span class="line">...</span><br><span class="line">&lt;source&gt;:12: error:   initializing argument 1 of &#39;D&lt;i&gt;::D(void*) [with int i &#x3D; 7]&#39;</span><br><span class="line">...</span><br><span class="line">&lt;source&gt;:12: error:   initializing argument 1 of &#39;D&lt;i&gt;::D(void*) [with int i &#x3D; 5]&#39;</span><br><span class="line">...</span><br><span class="line">&lt;source&gt;:12: error:   initializing argument 1 of &#39;D&lt;i&gt;::D(void*) [with int i &#x3D; 3]&#39;</span><br><span class="line">...</span><br><span class="line">&lt;source&gt;:12: error:   initializing argument 1 of &#39;D&lt;i&gt;::D(void*) [with int i &#x3D; 2]&#39;</span><br></pre></td></tr></table></figure>
<p>虽然这份代码可以使用GCC编译，不过有些遗憾的是，它依然无法编译成功。为了弥补这个缺憾，我再次对这份代码进行了修改，修改的目的有两个：</p>
<ol>
<li>使用现代C++语法；</li>
<li>消除错误信息，让代码能够顺利的编译。</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span>... args&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prime_values</span> &#123;</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> size = <span class="keyword">sizeof</span>...(args);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">T</span> <span class="title">t</span>, <span class="keyword">class</span> <span class="title">U</span>, <span class="title">template</span> &lt;</span>T...&gt; <span class="class"><span class="keyword">class</span> <span class="title">R</span>&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">add_to</span> &#123;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">T</span> <span class="title">t</span>, <span class="title">template</span> &lt;</span>T...&gt; <span class="class"><span class="keyword">class</span> <span class="title">U</span>, <span class="title">template</span> &lt;</span>T...&gt; <span class="class"><span class="keyword">class</span> <span class="title">R</span>,</span></span><br><span class="line"><span class="class">          <span class="title">T</span>... <span class="title">args</span>&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">add_to</span>&lt;</span>T, t, U&lt;args...&gt;, R&gt; &#123;</span><br><span class="line">  <span class="keyword">using</span> result = R&lt;t, args...&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="keyword">int</span> <span class="title">is_prime2</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i * i &lt;= n; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (n % i == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span> n, <span class="keyword">int</span>&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prime_list</span> &#123;</span></span><br><span class="line">  <span class="keyword">using</span> result = <span class="keyword">typename</span> prime_list&lt;n - <span class="number">1</span>, is_prime2(n - <span class="number">1</span>)&gt;::result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span> n&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prime_list</span>&lt;</span>n, <span class="number">1</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">using</span> result =</span><br><span class="line">      <span class="keyword">typename</span> add_to&lt;<span class="keyword">int</span>, n,</span><br><span class="line">                      <span class="keyword">typename</span> prime_list&lt;n - <span class="number">1</span>, is_prime2(n - <span class="number">1</span>)&gt;::result,</span><br><span class="line">                      prime_values&gt;::result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prime_list</span>&lt;</span><span class="number">2</span>, <span class="number">1</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">using</span> result = prime_values&lt;<span class="number">2</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span> n&gt;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">get_prime_list_t</span> = <span class="keyword">typename</span> prime_list&lt;n, n - <span class="number">2</span>&gt;::result;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LAST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST 18</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic <span class="meta-keyword">warning</span> <span class="meta-string">&quot;-Wsign-compare&quot;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DbgPrintType</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> &#123;</span> n = <span class="keyword">sizeof</span>(T) &gt; <span class="number">-1</span> &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRINT_TYPE(x) DbgPrintType<span class="meta-string">&lt;x&gt;();</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRINT_VALUE_TYPE(x) DbgPrintType<span class="meta-string">&lt;decltype(x)&gt;();</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">get_prime_list_t</span>&lt;LAST&gt; x;</span><br><span class="line">  PRINT_VALUE_TYPE(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于不熟悉模板元编程的读者来说，上面的代码可能不是很好理解。不过没关系，后面会详细介绍模板元编程的细节。现在我只是想让读者看到模板元编程的强大和有趣之处。</p>
<p>使用支持C++17标准的GCC可以成功编译以上代码并且输出以下警告信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test.cpp: In instantiation of &#39;struct DbgPrintType&lt;prime_values&lt;17, 13, 11, 7, 5, 3, 2&gt; &gt;&#39;:</span><br><span class="line">test.cpp:62:3:   required from here</span><br><span class="line">test.cpp:53:24: warning: comparison of integer expressions of different signedness: &#39;long long unsigned int&#39; and &#39;int&#39; [-Wsign-compare]</span><br><span class="line">   53 |   enum &#123; n &#x3D; sizeof(T) &gt; -1 &#125;;</span><br><span class="line">      |              ~~~~~~~~~~^~~~</span><br></pre></td></tr></table></figure>
<p>在这些警告信息中，我们可以清晰的看到一组倒序的质数序列<code>17, 13, 11, 7, 5, 3, 2</code>。值得注意的是，这条警告是我有意而为之的，目的是为了让编译器打印出质数序列。</p>
<p>事实上，从语法角度来说模板元编程是图灵完备（Turing Complete）的，也就是说理论上能够解决所有可计算的问题。不过有些遗憾的是，从编译器的角度来说模板元编程是图灵不完备的，因为作为循环的实现方法，递归在编译器中是有明确的深度限制的。</p>
<h2 id="范型编程与C-模板元编程"><a href="#范型编程与C-模板元编程" class="headerlink" title="范型编程与C++模板元编程"></a>范型编程与C++模板元编程</h2><p>泛型编程是一种编程风格，它允许程序员在强类型程序设计语言中编写代码时使用一些以后才指定的类型，并在实例化时作为参数指明这些类型。在C++语言中，实现范型编程的基础就是模板，换句话说模板也是为了让C++具有范型能力而设计的。</p>
<p>模板元编程则有些不同，正如我们在上文中看到的，它的出现更像是一个意外而并非有意设计。这也能解释模板元编程的语法为什么如此晦涩难懂。不过幸运的是，模板元编程除了晦涩难懂之外，还是带来了一些意外的惊喜。比如它可以为范型编程加入静态类型检查以及策略定制的能力。</p>
<h2 id="接下来做什么"><a href="#接下来做什么" class="headerlink" title="接下来做什么"></a>接下来做什么</h2><p>如果只是用C++模板元编程做数值计算，那么我敢肯定的说这种计算有90%是几乎没有意义的，因为使用运行期做数值计算往往是更好的方法。而真正让模板元编程具有价值的是它对类型的计算能力，通过类型计算能够让我们的代码更加通用且有更高的运行效率，当然代价是更加晦涩难懂的代码，更长的编译时间，以及更加复杂的错误信息。不过读者也不必担心这些代价，因为后续部分就是围绕着类型计算以及其相关问题展开的。</p>
<p>在后面的内容中，我们首先将接触到序列和元函数的概念以及它们的习惯用法。然后我们会使用序列和元函数完成基本的判断和循环操作。以上是模板元编程的基础部分，在此之后我们将实现一套轻量级的模板元编程库YAMPL（Yet Another MPL），YAMPL在接口上将非常接近Boost的MPL。请注意，实现YAMPL的目的并不是取代MPL，而是让我们牢牢掌握模板元编程的一种手段。</p>
<p>事实上，无论什么时候，只要用到模板元编程，STL的type_traits和Boost的MPL这些成熟的模板元编程库都应该是优先考虑的对象。其中STL的type_traits专注于完成关于类型的一些基本操作，它是模板元编程的基础设施，是一个正规模板元编程程序库必不可少的组成部分。而Boost的MPL则是一个强大的模板元编程框架，它构建于Boost的type_traits的基础之上，并且提供一套强大且连贯的工具集，这些工具能让C++模板元编程变得简单有趣。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/10/20/metaprogramming-overview/" data-id="ckk4wfm0m0099h4up32kq9lx8" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-printer-api-tip" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/03/printer-api-tip/">打印机API相关的一点记录</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/09/03/printer-api-tip/" class="article-date"><time datetime="2019-09-03T12:01:29.000Z" itemprop="datePublished">2019-09-03</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tips/">Tips</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>最近研究了一点Windows上打印相关的内容，发现打印这块的东西的确挺多的。比如纸张，分辨率，打印处理器，打印数据类型等等。</p>
<p>首先我们需要通过<code>EnumPrintersW</code>枚举打印机，为了方便我写了一个简单的类模板：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span> =</span> PRINTER_INFO_2, <span class="keyword">int</span> level = <span class="number">2</span>&gt;</span><br><span class="line">class CEnumPrinter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">void</span> Init(ULONG flags)</span><br><span class="line">    &#123;</span><br><span class="line">        ULONG bytes_needed = <span class="number">0</span>;</span><br><span class="line">        ULONG elems_returned = <span class="number">0</span>;</span><br><span class="line">        EnumPrintersW(flags, <span class="literal">nullptr</span>, level, <span class="literal">nullptr</span>, <span class="number">0</span>, &amp;bytes_needed, &amp;elems_returned);</span><br><span class="line">        buffer_.resize(bytes_needed);</span><br><span class="line">        EnumPrintersW(flags, <span class="literal">nullptr</span>, level, buffer_.data(), bytes_needed, &amp;bytes_needed, &amp;elems_returned);</span><br><span class="line">        elems_returned_ = elems_returned;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ULONG <span class="title">Count</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> elems_returned_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> T&amp; <span class="keyword">operator</span>[] (ULONG idx)</span><br><span class="line">    &#123;</span><br><span class="line">        assert(idx &lt; elems_returned_);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;T*&gt;(buffer_.data())[idx];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;UCHAR&gt; buffer_;</span><br><span class="line">    ULONG elems_returned_ = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在枚举和选择目标打印机之后可以通过<code>PRINTER_INFO_2</code>中的<code>pPrinterName</code>获得打印机句柄。为了方便也写了一个类：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CPrinterHandle</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~CPrinterHandle() </span><br><span class="line">    &#123;</span><br><span class="line">        Close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">Open</span><span class="params">(LPCWSTR printer_name)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;WCHAR&gt; name;</span><br><span class="line">        name.resize(wcslen(printer_name) + <span class="number">1</span>);</span><br><span class="line">        wcscpy_s(name.data(), name.size(), printer_name);</span><br><span class="line">        <span class="keyword">return</span> OpenPrinter(name.data(), &amp;printer_, <span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">HANDLE <span class="title">Detach</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        HANDLE h = printer_;</span><br><span class="line">        printer_ = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">HANDLE <span class="title">Attach</span><span class="params">(HANDLE printer)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        HANDLE h = printer_;</span><br><span class="line">        printer_ = printer;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (printer_) &#123;</span><br><span class="line">            ClosePrinter(printer_);</span><br><span class="line">            printer_ = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">HANDLE</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> printer_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    HANDLE printer_ = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>而通过这个句柄就可以做很多的事情了，比如获取打印机的具体配置，弹出打印机属性对话框等等，这里以获取其支持的纸张类型为例：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span> =</span> FORM_INFO_1, <span class="keyword">int</span> level = <span class="number">1</span>&gt;</span><br><span class="line">class CEnumPrinterForm &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">void</span> Init(HANDLE hp)</span><br><span class="line">    &#123;</span><br><span class="line">        ULONG bytes_needed = <span class="number">0</span>;</span><br><span class="line">        ULONG elems_returned = <span class="number">0</span>;</span><br><span class="line">        EnumForms(hp, level, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;bytes_needed, &amp;elems_returned);</span><br><span class="line">        buffer_.resize(bytes_needed);</span><br><span class="line">        EnumForms(hp, level, buffer_.data(), bytes_needed, &amp;bytes_needed, &amp;elems_returned);</span><br><span class="line">        elems_returned_ = elems_returned;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ULONG <span class="title">Count</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> elems_returned_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> T&amp; <span class="keyword">operator</span>[] (ULONG idx)</span><br><span class="line">    &#123;</span><br><span class="line">        assert(idx &lt; elems_returned_);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;T*&gt;(buffer_.data())[idx];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;UCHAR&gt; buffer_;</span><br><span class="line">    ULONG elems_returned_ = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以枚举出类似A3、A4、B5这种纸张类型。不过这套打印数据的函数有一些不太友好，因为通过打印机句柄打印数据，我们只能传输emf或者raw格式的数据。而我们比较熟悉的方法是通过DC绘制图形并且打印，这样所见即所得用起来会更舒适。不过，这套API没有提供用打印机句柄转换到HDC的方法。只能通过<code>PRINTER_INFO_2</code>中的<code>pPrinterName</code>和<code>pDevMode</code>重新打开一个HDC，然后通过HDC相关的API进行打印。例如：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">hdc = CreateDCW(<span class="literal">NULL</span>, info.pPrinterName, <span class="literal">NULL</span>, info.pDevMode);</span><br><span class="line">DOCINFO docInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">docInfo.cbSize = <span class="keyword">sizeof</span>(docInfo);</span><br><span class="line">docInfo.lpszDocName = <span class="string">L&quot;test&quot;</span>;</span><br><span class="line"></span><br><span class="line">RECT rc = &#123; <span class="number">40</span>, <span class="number">10</span> &#125;;</span><br><span class="line"></span><br><span class="line">StartDoc(hdc, &amp;docInfo);</span><br><span class="line">StartPage(hdc);</span><br><span class="line">DrawTextA(hdc, <span class="string">&quot;hello&quot;</span>, <span class="number">-1</span>, &amp;rc, DT_SINGLELINE | DT_NOCLIP);</span><br><span class="line">EndPage(hdc);</span><br><span class="line">StartPage(hdc);</span><br><span class="line">DrawTextA(hdc, <span class="string">&quot;world&quot;</span>, <span class="number">-1</span>, &amp;rc, DT_SINGLELINE | DT_NOCLIP);</span><br><span class="line">EndPage(hdc);</span><br><span class="line">EndDoc(hdc);</span><br></pre></td></tr></table></figure>
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/09/03/printer-api-tip/" data-id="ckk4wfm0l0097h4up0ui1epot" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-vs-with-qt4-natvis" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/01/vs-with-qt4-natvis/">vs使用qt4.natvis</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/08/01/vs-with-qt4-natvis/" class="article-date"><time datetime="2019-08-01T01:05:03.000Z" itemprop="datePublished">2019-08-01</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tips/">Tips</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>上一篇blog讲到了windbg使用qt4.natvis解析qt数据结构的方法，那么接下来就该轮到VS了。在VS中使用natvis会更加简单，只需要将qt4.nativs拷贝到<code>%VSINSTALLDIR%\Common7\Packages\Debugger\Visualizers</code>即可。当然，这篇blog不可能只写这么点东西。qt4.natvis很好，它解析了很多QT的数据结构，比如QMap，QPoint，QVector，QMatrix等等，不过有一点很遗憾，它没有解析QObject。因为解析QObject可以获取对象的父子节点，这样很容易了解对象的树形结构。于是我这里对qt4.natvis进行了一点修改，添加了对QObject的解析：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Type</span> <span class="attr">Name</span>=<span class="string">&quot;QObject&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DisplayString</span>&gt;</span>&#123;&#123;&#123;*(char **)(*(char **)(*(char **)this - 4) + 12) + 12,sb&#125;&#125;&#125;<span class="tag">&lt;/<span class="name">DisplayString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Expand</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ExpandedItem</span>&gt;</span>d_ptr.d-&gt;children<span class="tag">&lt;/<span class="name">ExpandedItem</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Expand</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Type</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>解释一下这段xml，<code>&lt;Type Name=&quot;QObject&quot;&gt;&quot;</code>是指定匹配的对象类型名，这里当然就是QObject了。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">DisplayString</span>&gt;</span>&#123;&#123;&#123;*(char **)(*(char **)(*(char **)this - 4) + 12) + 12,sb&#125;&#125;&#125;<span class="tag">&lt;/<span class="name">DisplayString</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>用于展示当前QObject的实际类型，也就是QObject的派生类名。这里采用的方法是获取虚表上的<code>RTTICompleteObjectLocator</code>对象指针，然后在获取<code>TypeDescriptor</code>。具体是怎么获取的那将是一篇长篇大论，这里就不展开了。最后<code>&lt;ExpandedItem&gt;d_ptr.d-&gt;children&lt;/ExpandedItem&gt;</code>则是将其子对象展示出来，这样就能一目了然的指定其子对象的真实类型了。</p>
<p><img src="/uploads/2019/08/20190801183332.png" alt="20190801183332"></p>
<p>从图中可以看到，除了str、str_list和str_map可以直接的看到数据之外，QMsgTest、QToolBar的子对象个数和类型也能一目了然。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/08/01/vs-with-qt4-natvis/" data-id="ckk4wfm0k0095h4up8oz05uno" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-windbg-with-qt4-natvis" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/30/windbg-with-qt4-natvis/">windbg使用qt4.natvis</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/07/30/windbg-with-qt4-natvis/" class="article-date"><time datetime="2019-07-30T10:59:11.000Z" itemprop="datePublished">2019-07-30</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tips/">Tips</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>用windbg调试QT程序或者分析QT程序的dump是一件痛苦的事情，因为windbg缺少对QT基础数据的展示能力，比如：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QString str = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    QList&lt;QString&gt; str_list;</span><br><span class="line">    str_list.append(str);</span><br><span class="line">    QMap&lt;<span class="keyword">int</span>, QString&gt; str_map;</span><br><span class="line">    str_map[<span class="number">11</span>] = str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这份代码使用windbg查看str，str_list或者str_map简直是一件折磨的事情。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; dv</span><br><span class="line">           argc &#x3D; 0n1</span><br><span class="line">           argv &#x3D; 0x02cc5e00</span><br><span class="line">            str &#x3D; class QString</span><br><span class="line">       str_list &#x3D; class QList&lt;QString&gt;</span><br><span class="line">        str_map &#x3D; class QMap&lt;int,QString&gt;</span><br><span class="line">              a &#x3D; class QApplication</span><br><span class="line">              w &#x3D; class QMsgTest</span><br><span class="line">0:000&gt; dx str</span><br><span class="line">str                 [Type: QString]</span><br><span class="line">    [+0x000] d                : 0x2cc5d80 [Type: QString::Data *]</span><br><span class="line">0:000&gt; dx str_list</span><br><span class="line">str_list                 [Type: QList&lt;QString&gt;]</span><br><span class="line">    [+0x000] p                [Type: QListData]</span><br><span class="line">    [+0x000] d                : 0x2cc7258 [Type: QListData::Data *]</span><br><span class="line">0:000&gt; dx str_map</span><br><span class="line">str_map                 [Type: QMap&lt;int,QString&gt;]</span><br><span class="line">    [+0x000] d                : 0x2cc72b8 [Type: QMapData *]</span><br><span class="line">    [+0x000] e                : 0x2cc72b8 [Type: QMapData::Node *]</span><br></pre></td></tr></table></figure>
<p>可以看到，windbg只会告诉你类型，根本不会给你展示数据本身，如果要查看数据还得自己来算，以最复杂的QMap为例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; ?? str_map.d-&gt;forward[0]</span><br><span class="line">struct QMapData * 0x031470f8</span><br><span class="line">   +0x000 backward         : 0x03147068 QMapData</span><br><span class="line">   +0x004 forward          : [12] 0x03147068 QMapData</span><br><span class="line">   +0x034 ref              : QBasicAtomicInt</span><br><span class="line">   +0x038 topLevel         : 0n-17891602</span><br><span class="line">   +0x03c size             : 0n-17891602</span><br><span class="line">   +0x040 randomBits       : 0xfeeefeee</span><br><span class="line">   +0x044 insertInOrder    : 0y0</span><br><span class="line">   +0x044 sharable         : 0y1</span><br><span class="line">   +0x044 strictAlignment  : 0y1</span><br><span class="line">   +0x044 reserved         : 0y11111110111011101111111011101 (0x1fdddfdd)</span><br><span class="line"></span><br><span class="line">0:000&gt; ?? sizeof(@!&quot;qtmsgtest!QMapPayloadNode&lt;int,QString&gt;&quot;)-sizeof(qtmsgtest!QMapData::Node*)</span><br><span class="line">unsigned int 8</span><br><span class="line"></span><br><span class="line">0:000&gt; dt qtmsgtest!QMapNode&lt;int,QString&gt; (0x31470f8-8)</span><br><span class="line">   +0x000 key              : 0n11</span><br><span class="line">   +0x004 value            : QString</span><br><span class="line">   +0x008 backward         : 0x03147068 QMapData::Node</span><br><span class="line">   +0x00c forward          : [1] 0x03147068 QMapData::Node</span><br><span class="line"></span><br><span class="line">0:000&gt; ?? ((qtmsgtest!QString*)0x31470f4)-&gt;d</span><br><span class="line">struct QString::Data * 0x03145b30</span><br><span class="line">   +0x000 ref              : QBasicAtomicInt</span><br><span class="line">   +0x004 alloc            : 0n11</span><br><span class="line">   +0x008 size             : 0n11</span><br><span class="line">   +0x00c data             : 0x03145b42  -&gt; 0x68</span><br><span class="line">   +0x010 clean            : 0y0</span><br><span class="line">   +0x010 simpletext       : 0y0</span><br><span class="line">   +0x010 righttoleft      : 0y0</span><br><span class="line">   +0x010 asciiCache       : 0y0</span><br><span class="line">   +0x010 capacity         : 0y0</span><br><span class="line">   +0x010 reserved         : 0y11001101110 (0x66e)</span><br><span class="line">   +0x012 array            : [1] 0x68</span><br><span class="line"></span><br><span class="line">0:000&gt; du @@C++(((qtmsgtest!QString*)0x31470f4)-&gt;d-&gt;data)</span><br><span class="line">03145b42  &quot;hello world&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>你们看，为了获取key=11、value=”hello world”需要这么折腾一通，如果数据多了那不得抓狂。</p>
<p>不过幸运了是windbg现在支持natvis了，简单的说就是通过natvis里的配置自动解析和符号匹配的数据结构。接下来要做的就是找一个好用的qt的natvis了。我这里找了一个qt配合vs2012里的qt4.natvis，让我们看看加载后的效果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0:000&gt; .nvload qt4.natvis</span><br><span class="line">Successfully loaded visualizers in &quot;C:\Program Files (x86)\Windows Kits\10\Debuggers\x86\Visualizers\qt4.natvis&quot;</span><br><span class="line">0:000&gt; dv</span><br><span class="line">           argc &#x3D; 0n1</span><br><span class="line">           argv &#x3D; 0x02cc5e00</span><br><span class="line">            str &#x3D; hello world</span><br><span class="line">       str_list &#x3D; &#123; size &#x3D; 1 &#125;</span><br><span class="line">        str_map &#x3D; &#123; size &#x3D; 1 &#125;</span><br><span class="line">              a &#x3D; class QApplication</span><br><span class="line">              w &#x3D; class QMsgTest</span><br><span class="line">0:000&gt; dx str</span><br><span class="line">str                 : hello world [Type: QString]</span><br><span class="line">    [&lt;Raw View&gt;]     [Type: QString]</span><br><span class="line">    [size]           : 11 [Type: int]</span><br><span class="line">    [referenced]     : 3 [Type: long]</span><br><span class="line">    [0]              : 0x68 [Type: unsigned short]</span><br><span class="line">    [1]              : 0x65 [Type: unsigned short]</span><br><span class="line">    [2]              : 0x6c [Type: unsigned short]</span><br><span class="line">    [3]              : 0x6c [Type: unsigned short]</span><br><span class="line">    [4]              : 0x6f [Type: unsigned short]</span><br><span class="line">    [5]              : 0x20 [Type: unsigned short]</span><br><span class="line">    [6]              : 0x77 [Type: unsigned short]</span><br><span class="line">    [7]              : 0x6f [Type: unsigned short]</span><br><span class="line">    [8]              : 0x72 [Type: unsigned short]</span><br><span class="line">    [9]              : 0x6c [Type: unsigned short]</span><br><span class="line">    [10]             : 0x64 [Type: unsigned short]</span><br><span class="line">0:000&gt; dx str_list</span><br><span class="line">str_list                 : &#123; size &#x3D; 1 &#125; [Type: QList&lt;QString&gt;]</span><br><span class="line">    [&lt;Raw View&gt;]     [Type: QList&lt;QString&gt;]</span><br><span class="line">    [referenced]     : 1 [Type: long]</span><br><span class="line">    [0x0]            : hello world [Type: QString]</span><br><span class="line">0:000&gt; dx str_map</span><br><span class="line">str_map                 : &#123; size &#x3D; 1 &#125; [Type: QMap&lt;int,QString&gt;]</span><br><span class="line">    [&lt;Raw View&gt;]     [Type: QMap&lt;int,QString&gt;]</span><br><span class="line">    [referenced]     : 1 [Type: long]</span><br><span class="line">    [0x0]            : 0x2cc7340 : (11, hello world) [Type: QMapNode&lt;int,QString&gt; *]</span><br></pre></td></tr></table></figure>
<p>看到了么，无论是str，str_list还是str_map都直接打印出了内部的数据，无需大费周章的折腾，这简直是windbg爱好者调试qt程序的神器。</p>
<p>最后附上qt4.natvis的地址：<a target="_blank" rel="noopener" href="https://gist.github.com/gregseth/9bcd0112f8492fa7bfe7">https://gist.github.com/gregseth/9bcd0112f8492fa7bfe7</a></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/07/30/windbg-with-qt4-natvis/" data-id="ckk4wfm0k0093h4upbfba2fwt" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-dump-qt-objects" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/30/dump-qt-objects/">Dump QT objects</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/06/30/dump-qt-objects/" class="article-date"><time datetime="2019-06-30T03:14:09.000Z" itemprop="datePublished">2019-06-30</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tips/">Tips</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>在QT中，QObject有两个函数<code>dumpObjectInfo()</code>和<code>dumpObjectTree() </code>分别用于dump相关对象树形结构和相关的连接信息。不过这两个函数有个共同的问题，只能在debug模式下使用。因为在Release模式下，这两个函数不做任何事情：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dumpRecursive</span><span class="params">(<span class="keyword">int</span> level, QObject *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(QT_DEBUG)</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    Q_UNUSED(level)</span><br><span class="line">    Q_UNUSED(object)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QObject::dumpObjectTree</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dumpRecursive(<span class="number">0</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QObject::dumpObjectInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(QT_DEBUG)</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了能在Release模式下使用这两个函数，其中一个办法是删除<code>#if defined(QT_DEBUG)</code>宏，然后重新编译qtcore4.dll。不过重新编译QT需要一些准备工作，而且还需要较长的一段编译时间，所以我果断放弃了这种方法。</p>
<p>第二种想到的方法是自己实现<code>dumpObjectInfo()</code>和<code>dumpObjectTree() </code>这两个函数。实际上，实现<code>dumpObjectTree()</code>并不是一件难事，<code>qDebug()</code>本身就能dump QObject了，我们需要做的就是递归遍历对象节点：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dumpObjects</span><span class="params">(<span class="keyword">const</span> QObjectList &amp;objs, <span class="keyword">int</span> nIndent = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QString strIndent;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nIndent; i++) &#123;</span><br><span class="line">        strIndent.append(<span class="string">&quot;  &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Q_FOREACH(<span class="keyword">const</span> QObject *obj, objs)</span><br><span class="line">    &#123;</span><br><span class="line">        qDebug() &lt;&lt; strIndent.toAscii().data() &lt;&lt; obj;</span><br><span class="line">        <span class="keyword">if</span> (!obj-&gt;children().isEmpty()) &#123;</span><br><span class="line">            dumpObjects(obj-&gt;children(), nIndent + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在想要遍历QT对象时，我们只需要将对象的子节点列表传入函数即可：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">QMsgTest w;</span><br><span class="line">dumpObjects(w.children());</span><br></pre></td></tr></table></figure>
<p>输出的数据如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">QMainWindowLayout(0x36ba208, name &#x3D; &quot;_layout&quot;) </span><br><span class="line"> QRubberBand(0x36ba778, name &#x3D; &quot;qt_rubberband&quot;) </span><br><span class="line"> QMenuBar(0x36bab78, name &#x3D; &quot;menuBar&quot;) </span><br><span class="line">   QToolButton(0x36bae88, name &#x3D; &quot;qt_menubar_ext_button&quot;) </span><br><span class="line"> QToolBar(0x36bb820, name &#x3D; &quot;mainToolBar&quot;) </span><br><span class="line">   QToolBarLayout(0x36bbb50) </span><br><span class="line">   QToolBarExtension(0x36bbc80, name &#x3D; &quot;qt_toolbar_ext_button&quot;) </span><br><span class="line">   QAction(0x36bc5a0) </span><br><span class="line">   QPropertyAnimation(0x36bcf90) </span><br><span class="line">   QPropertyAnimation(0x35098f8) </span><br><span class="line"> QWidget(0x36bcac0, name &#x3D; &quot;centralWidget&quot;) </span><br><span class="line">   QPropertyAnimation(0x36bbed8) </span><br><span class="line">   QPropertyAnimation(0x3509cf0) </span><br><span class="line"> QStatusBar(0x36bcd70, name &#x3D; &quot;statusBar&quot;) </span><br><span class="line">   QSizeGrip(0x36bbac0) </span><br><span class="line">   QHBoxLayout(0x36b3ad0) </span><br><span class="line">     QVBoxLayout(0x36bd5d8) </span><br><span class="line">       QHBoxLayout(0x36bd818) </span><br></pre></td></tr></table></figure>


<p>怎么样，是不是很容易实现。不过接下来就要泼一盆冷水了，因为<code>dumpObjectInfo()</code>函数就没有那么容易实现了。主要原因是<code>dumpObjectInfo()</code>函数中有大量的依赖关系，如果单纯的扣代码过来牵扯会非常广，所以这个方法似乎也进行不下去了。</p>
<p>最后，我想到了第三种方法，在Release模式下加载Debug版本的qtcored4.dll，获取其函数地址并且直接调用它。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">PVOID dumpFunc = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">void</span>* (*myInstallMsgHandler)(<span class="keyword">void</span>* h) = <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> myMsgHandler(QtMsgType t, <span class="keyword">const</span> <span class="keyword">char</span>* str)</span><br><span class="line">&#123;</span><br><span class="line">    OutputDebugStringW(QString(<span class="string">&quot;%1\n&quot;</span>).arg(str).utf16());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HMODULE h = LoadLibraryW(<span class="string">L&quot;qtcored4.dll&quot;</span>);</span><br><span class="line">    dumpFunc = GetProcAddress(h, <span class="string">&quot;?dumpObjectInfo@QObject@@QAEXXZ&quot;</span>);</span><br><span class="line">    *(<span class="keyword">void</span> **)&amp;myInstallMsgHandler = GetProcAddress(h, <span class="string">&quot;?qInstallMsgHandler@@YAP6AXW4QtMsgType@@PBD@ZP6AX01@Z@Z&quot;</span>);</span><br><span class="line">    myInstallMsgHandler(myMsgHandler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dumpObjInfo</span><span class="params">(<span class="keyword">void</span> *obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov ecx, obj</span><br><span class="line">        call dumpFunc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Init();</span><br><span class="line"></span><br><span class="line">    <span class="function">QApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">    QMsgTest w;</span><br><span class="line">    w.show();</span><br><span class="line">    dumpObjInfo(&amp;w);</span><br><span class="line">    <span class="keyword">return</span> a.exec();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>解释一下这段代码，首先Init函数是用来加载qtcored4.dll以及初始化相关的函数，这里GetProcAddress获取的函数分别是<code>qInstallMsgHandler</code>和<code>dumpObjectInfo</code>，之所以代码中的函数名这么复杂是因为C++使用的Decorated Name规则导致的，可以用一些PE工具查看导出函数来获取这个名字。另外我们看到，出了获取<code>dumpObjectInfo</code>函数外，还获取了<code>qInstallMsgHandler</code>函数。因为我们需要使用这个函数注册输出调试信息的函数，在代码中是<code>myMsgHandler</code>。最后，为了方便的调用<code>dumpObjectInfo</code>的函数指针，我采用了内嵌汇编的方式。因为<code>dumpObjectInfo</code>是成员函数，所以肯定是thiscall，于是将obj赋予ecx寄存器并且调用函数指针即可。</p>
<p>编译运行可以看到输出结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BJECT QMsgTest::QMsgTestClass</span><br><span class="line">  SIGNALS OUT</span><br><span class="line">        signal: destroyed(QObject*)</span><br><span class="line">        signal: destroyed()</span><br><span class="line">        signal: customContextMenuRequested(QPoint)</span><br><span class="line">        signal: iconSizeChanged(QSize)</span><br><span class="line">          --&gt; QToolBar::mainToolBar _q_updateIconSize(QSize)</span><br><span class="line">        signal: toolButtonStyleChanged(Qt::ToolButtonStyle)</span><br><span class="line">          --&gt; QToolBar::mainToolBar _q_updateToolButtonStyle(Qt::ToolButtonStyle)</span><br><span class="line">  SIGNALS IN</span><br><span class="line">        &lt;None&gt;</span><br></pre></td></tr></table></figure>
<p>当然了，内嵌汇编不是一个好的代码风格，这里只是为了快速验证方案的可行性。更符合C++语法习惯的方式应该是声明一个成员函数指针，然后用<code>GetProcAddress</code>获取对应的函数地址对其赋值，最后调用成员函数指针。具体怎么实现仁者见仁智者见智，我这篇blog只是抛砖引玉。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/06/30/dump-qt-objects/" data-id="ckk4wfm0i0091h4upgjok3a44" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-qt-event-wds" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/29/qt-event-wds/">windbg监听QT事件</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/05/29/qt-event-wds/" class="article-date"><time datetime="2019-05-29T06:18:58.000Z" itemprop="datePublished">2019-05-29</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tips/">Tips</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Windows平台下做过界面开发的程序员肯定知道窗口界面是由消息驱动的。为了能方便的调试窗口消息循环，Windows提供了spy++这样的工具帮助我们监控消息。但是Windows的消息在QT的程序上可能只有部分有用。所以我们还需要一个监控QT窗口事件的工具，不过可惜的是我并没有找到这样现成的工具。于是我用Windbg的断点命令写了一个。</p>
<p>不过写断点命令之前必须先搞清楚在QT中事件都是怎么发出来的。经过调试确认了几个函数，分别是：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">QCoreApplication::sendEvent</span><br><span class="line">QCoreApplication::sendSpontaneousEvent</span><br><span class="line">QCoreApplication::postEvent</span><br></pre></td></tr></table></figure>
<p>接下来我们可以对它们下断点了。当然，这里不是直接了当下断点那么的简单。我们需要在断点中插入命令，让断点命中后打印我们想要的内容，然后继续运行。我这里的写法是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bm &#x2F;( qtcored4!QCoreApplication::postEvent &quot;.printf \&quot;P  \&quot;;?? @@C++(static_cast&lt;QtGuid4!QEvent::Type&gt;(event-&gt;t));g&quot;</span><br><span class="line">bc 2</span><br><span class="line">bm &#x2F;( qtcored4!QCoreApplication::sendEvent &quot;.printf \&quot;S  \&quot;;?? @@C++(static_cast&lt;QtGuid4!QEvent::Type&gt;(event-&gt;t));g&quot;</span><br><span class="line">bm &#x2F;( qtcored4!QCoreApplication::sendSpontaneousEvent &quot;.printf \&quot;SS \&quot;;?? @@C++(static_cast&lt;QtGuid4!QEvent::Type&gt;(event-&gt;t));g&quot;</span><br></pre></td></tr></table></figure>
<p>在windbg中执行后，运行程序就能看到事件一个一个的打印出来了，而且打印出来的并不是冷冰冰的事件数字，而是数字所代表的含义：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SS QEvent::Type WindowDeactivate (0n25)</span><br><span class="line">P  QEvent::Type UpdateRequest (0n77)</span><br><span class="line">S  QEvent::Type WindowDeactivate (0n25)</span><br><span class="line">S  QEvent::Type WindowDeactivate (0n25)</span><br><span class="line">SS QEvent::Type ActivationChange (0n99)</span><br><span class="line">SS QEvent::Type ApplicationDeactivate (0n122)</span><br><span class="line">S  QEvent::Type UpdateRequest (0n77)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type ApplicationActivate (0n121)</span><br><span class="line">SS QEvent::Type WindowActivate (0n24)</span><br><span class="line">P  QEvent::Type UpdateRequest (0n77)</span><br><span class="line">S  QEvent::Type WindowActivate (0n24)</span><br><span class="line">S  QEvent::Type WindowActivate (0n24)</span><br><span class="line">S  QEvent::Type WindowActivate (0n24)</span><br><span class="line">SS QEvent::Type ActivationChange (0n99)</span><br><span class="line">S  QEvent::Type UpdateRequest (0n77)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type Paint (0n12)</span><br><span class="line">SS QEvent::Type NonClientAreaMouseMove (0n173)</span><br><span class="line">S  QEvent::Type Enter (0n10)</span><br><span class="line">S  QEvent::Type Enter (0n10)</span><br><span class="line">SS QEvent::Type MouseMove (0n5)</span><br><span class="line">S  QEvent::Type Leave (0n11)</span><br><span class="line">S  QEvent::Type Enter (0n10)</span><br><span class="line">SS QEvent::Type MouseMove (0n5)</span><br><span class="line">SS QEvent::Type MouseMove (0n5)</span><br><span class="line">SS QEvent::Type MouseMove (0n5)</span><br><span class="line">SS QEvent::Type MouseMove (0n5)</span><br><span class="line">SS QEvent::Type MouseMove (0n5)</span><br><span class="line">SS QEvent::Type MouseMove (0n5)</span><br><span class="line">S  QEvent::Type Leave (0n11)</span><br><span class="line">S  QEvent::Type Leave (0n11)</span><br><span class="line">SS QEvent::Type WindowDeactivate (0n25)</span><br><span class="line">P  QEvent::Type UpdateRequest (0n77)</span><br><span class="line">S  QEvent::Type WindowDeactivate (0n25)</span><br><span class="line">S  QEvent::Type WindowDeactivate (0n25)</span><br><span class="line">S  QEvent::Type WindowDeactivate (0n25)</span><br><span class="line">SS QEvent::Type ActivationChange (0n99)</span><br><span class="line">SS QEvent::Type ApplicationDeactivate (0n122)</span><br><span class="line">S  QEvent::Type UpdateRequest (0n77)</span><br></pre></td></tr></table></figure>



      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/05/29/qt-event-wds/" data-id="ckk4wfm0i008zh4up665v93tq" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-timesync-script" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/25/timesync-script/">一个时间同步脚本</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/04/25/timesync-script/" class="article-date"><time datetime="2019-04-25T09:07:46.000Z" itemprop="datePublished">2019-04-25</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tips/">Tips</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>家里有台电脑不知道为啥一直同步不了网络时间，每隔一段时间就慢个几分钟，于是在网上找了点资料和代码拼凑了一个用于Windows时间同步的python脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@author: 0cch</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> ctypes             <span class="keyword">import</span> Structure, windll, pointer</span><br><span class="line"><span class="keyword">from</span> ctypes.wintypes    <span class="keyword">import</span> WORD</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYSTEMTIME</span>(<span class="params">Structure</span>):</span></span><br><span class="line">  _fields_ = [</span><br><span class="line">      ( <span class="string">&#x27;wYear&#x27;</span>,            WORD ),</span><br><span class="line">      ( <span class="string">&#x27;wMonth&#x27;</span>,           WORD ),</span><br><span class="line">      ( <span class="string">&#x27;wDayOfWeek&#x27;</span>,       WORD ),</span><br><span class="line">      ( <span class="string">&#x27;wDay&#x27;</span>,             WORD ),</span><br><span class="line">      ( <span class="string">&#x27;wHour&#x27;</span>,            WORD ),</span><br><span class="line">      ( <span class="string">&#x27;wMinute&#x27;</span>,          WORD ),</span><br><span class="line">      ( <span class="string">&#x27;wSecond&#x27;</span>,          WORD ),</span><br><span class="line">      ( <span class="string">&#x27;wMilliseconds&#x27;</span>,    WORD ),</span><br><span class="line">    ]</span><br><span class="line">SetLocalTime = windll.kernel32.SetLocalTime</span><br><span class="line"></span><br><span class="line">NTP_SERVER = <span class="string">&quot;pool.ntp.org&quot;</span></span><br><span class="line">TIME1970 = <span class="number">2208988800</span></span><br><span class="line"></span><br><span class="line">clientSocket = socket(AF_INET, SOCK_DGRAM)</span><br><span class="line">clientSocket.settimeout(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">portNumber = <span class="number">123</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sntp_client</span>():</span></span><br><span class="line">    data = <span class="string">&#x27;\x1b&#x27;</span> + <span class="number">47</span> * <span class="string">&#x27;\0&#x27;</span></span><br><span class="line">    clientSocket.sendto( data.encode(<span class="string">&#x27;utf-8&#x27;</span>), ( NTP_SERVER, portNumber ))</span><br><span class="line">    data, address = clientSocket.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&#x27;Response received from:&#x27;</span>, address)</span><br><span class="line">        t_time = struct.unpack( <span class="string">&#x27;!12I&#x27;</span>, data )[<span class="number">10</span>]</span><br><span class="line">        t_time -= TIME1970</span><br><span class="line">        </span><br><span class="line">        dt = datetime.datetime.fromtimestamp( t_time )</span><br><span class="line">        </span><br><span class="line">        dt_tuple = dt.timetuple()</span><br><span class="line">        st = SYSTEMTIME()</span><br><span class="line">        st.wYear            = dt_tuple.tm_year</span><br><span class="line">        st.wMonth           = dt_tuple.tm_mon</span><br><span class="line">        st.wDayOfWeek       = ( dt_tuple.tm_wday + <span class="number">1</span> ) % <span class="number">7</span></span><br><span class="line">        st.wDay             = dt_tuple.tm_mday</span><br><span class="line">        st.wHour            = dt_tuple.tm_hour</span><br><span class="line">        st.wMinute          = dt_tuple.tm_min</span><br><span class="line">        st.wSecond          = dt_tuple.tm_sec</span><br><span class="line">        st.wMilliseconds    = <span class="number">0</span></span><br><span class="line">         </span><br><span class="line">        ret = SetLocalTime( pointer( st ) )</span><br><span class="line">        <span class="keyword">if</span> ret == <span class="number">0</span>:</span><br><span class="line">            print( <span class="string">&#x27;Setting failed. Try as administrator.&#x27;</span> )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print( <span class="string">&#x27;Successfully.&#x27;</span> )</span><br><span class="line">        </span><br><span class="line">    clientSocket.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sntp_client()</span><br></pre></td></tr></table></figure>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/04/25/timesync-script/" data-id="ckk4wfm0h008xh4upfb3k6jy3" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-cpp11-macro" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/20/cpp11-macro/">C++11新增预定义的宏</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/03/20/cpp11-macro/" class="article-date"><time datetime="2019-03-20T13:39:56.000Z" itemprop="datePublished">2019-03-20</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tips/">Tips</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>C++11中新增了4个预定义的宏，他们分别为<code>__STDC__</code>，<code>__STDC_HOSTED__</code>，<code>__STDC_VERSION__</code>和<code>__STDC_ISO_10646__</code>。</p>
<ol>
<li><p><code>__STDC__</code>用于指示编译器是否支持ISO标准C语言，如果支持ISO标准C语言则<code>_STDC__</code>定义为1，否为定义为0。这个宏在不同的编译器上可能有不同的定义，甚至有未定义的情况。例如在GCC上，编译并输出该宏的值为1，而在Visual Studio C++上，默认情况下该宏处于未定义状态。</p>
</li>
<li><p><code>__STDC_HOSTED__</code>用于指示宿主环境是否具有标准C库的完整功能，如果具有标准C库的完整功能则<code>__STDC_HOSTED__</code>定义为1，否为定义为0。</p>
</li>
<li><p><code>__STDC_VERSION__</code>用于定义C标准的版本号，但是标准文档中并没有明确规定其实现，所以在很多编译器中这个宏处于未定义状态。</p>
</li>
<li><p><code>__STDC_ISO_10646__</code>用于指示<code>wchar_t</code>是否使用Unicode，如果使用Unicode那么<code>wchar_t</code>展开为yyyymmL的形式。</p>
</li>
</ol>
<p>编译运行下面这段代码用于检测这些宏的定义状态：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__cplusplus is &quot;</span> &lt;&lt; __cplusplus &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__DATE__ is &quot;</span> &lt;&lt; __DATE__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__FILE__ is &quot;</span> &lt;&lt; __FILE__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__LINE__ is &quot;</span> &lt;&lt; __LINE__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __STDC_HOSTED__</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC_HOSTED__ is &quot;</span> &lt;&lt; __STDC_HOSTED__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC_HOSTED__ is not defined&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__TIME__ is &quot;</span> &lt;&lt; __TIME__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __STDC__</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC__ is &quot;</span> &lt;&lt; __STDC__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC__ is not defined&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __STDC_MB_MIGHT_NEQ_WC__</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC_MB_MIGHT_NEQ_WC__ is &quot;</span> &lt;&lt; __STDC_MB_MIGHT_NEQ_WC__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC_MB_MIGHT_NEQ_WC__ is not defined&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __STDC_VERSION__</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC_VERSION__ is &quot;</span> &lt;&lt; __STDC_VERSION__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC_VERSION__ is not defined&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __STDC_ISO_10646__</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC_ISO_10646__ is &quot;</span> &lt;&lt; __STDC_ISO_10646__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDC_ISO_10646__ is not defined&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __STDCPP_DEFAULT_NEW_ALIGNMENT__</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDCPP_DEFAULT_NEW_ALIGNMENT__ is &quot;</span> &lt;&lt; __STDCPP_DEFAULT_NEW_ALIGNMENT__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDCPP_DEFAULT_NEW_ALIGNMENT__ is not defined&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __STDCPP_STRICT_POINTER_SAFETY__</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDCPP_STRICT_POINTER_SAFETY__ is &quot;</span> &lt;&lt; __STDCPP_STRICT_POINTER_SAFETY__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDCPP_STRICT_POINTER_SAFETY__ is not defined&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __STDCPP_THREADS__</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDCPP_THREADS__ is &quot;</span> &lt;&lt; __STDCPP_THREADS__ &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__STDCPP_THREADS__ is not defined&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/03/20/cpp11-macro/" data-id="ckk4wfm0g008vh4up1zphdp0m" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-compile-gcc-in-windows" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/22/compile-gcc-in-windows/">在Windows中编译GCC</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/02/22/compile-gcc-in-windows/" class="article-date"><time datetime="2019-02-22T11:00:12.000Z" itemprop="datePublished">2019-02-22</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tips/">Tips</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>最近心血来潮想体验下C++2a的标准，但是mingw中的GCC最新版本是8.2。于是乎就产生了编译thunk下最新代码的想法。</p>
<p>要在Windows上编译GCC没有在linux上方便，但是也是可以完成的。首先我们需要一个mingw的环境。自带mingw环境的软件有很多，这里我比较推荐MSYS2，因为这个环境更新的比较快。下载安装好了以后，运行MSYS2，会弹出类似linux终端窗口。这里我们首先下载需要的开发编译环境：</p>
<blockquote>
<p>pacman -S –needed mingw-w64-i686-toolchain mingw-w64-x86_64-toolchain</p>
</blockquote>
<p>下载安装好了开发环境后，可以下载GCC源代码：</p>
<blockquote>
<p>mkdir gcc-latest<br>cd gcc-latest<br>git clone git://gcc.gnu.org/git/gcc.git</p>
</blockquote>
<p>源代码比较大（2个多G），下载需要一点耐心。<br>源代码下载完成后，创建编译目录：</p>
<blockquote>
<p>mkdir build</p>
</blockquote>
<p>在开始编译之前，有一个坑需要注意下，我们需要将usr/bin/下的makeinfo改名。不知道为什么，最新的makeinfo对gcc的texi文件不兼容会导致编译失败。这个操作之后就可以开始配置了。</p>
<blockquote>
<p>../gcc/configure –enable-languages=c,c++ –disable-multilib –disable-bootstrap –disable-werror –disable-nls –prefix=/mingw64/gcc-latest –build=x86_64-w64-mingw32 –host=x86_64-w64-mingw32 –target=x86_64-w64-mingw32 –with-native-system-header-dir=/mingw64/x86_64-w64-mingw32/include –with-arch=x86-64 MAKEINFO=missing<br>export LIBRARY_PATH=/mingw64/x86_64-w64-mingw32/lib</p>
</blockquote>
<p>配置的选项比较多，我们可以参考GCC文档进行参照。这里的配置是我尝试后感觉必须加入的，否则编译的时候会出相应的问题。可以说是编译GCC血泪史了。<br>再然后就可以开始编译了：</p>
<blockquote>
<p>make -j 16</p>
</blockquote>
<p>使用多线程编译，编译速度会快不少。编译好了以后就可以安装了，注意安装的时候可能会遇到失败，需要注释build/gcc/makefile中，对应s-tm-texi的相关代码。</p>
<blockquote>
<p>make install</p>
</blockquote>
<p>最后检查gcc版本号：</p>
<blockquote>
<p>gcc -v</p>
</blockquote>
<p>注意目前最新的版本号为9.0.1。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/02/22/compile-gcc-in-windows/" data-id="ckk4wfm0g008th4up5dii5wx3" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-use-ccomptr-in-loops-requires-special-attention" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/20/use-ccomptr-in-loops-requires-special-attention/">在循环中使用CComPtr需要特别注意</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2019/01/20/use-ccomptr-in-loops-requires-special-attention/" class="article-date"><time datetime="2019-01-20T13:57:37.000Z" itemprop="datePublished">2019-01-20</time></a>
</div>

    <div class="article-author">admin</div>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tips/">Tips</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>CComPtr是ATL里提供给我们管理COM接口的智能指针类，使用它能够让我们无需关心接口的引用释放。例如：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">CComPtr&lt;IShellFolder&gt; pDesktop;</span><br><span class="line">SHGetDesktopFolder(&amp;pDesktop);</span><br></pre></td></tr></table></figure>
<p>但是这个类在循环中使用的时候要特别注意一下，例如：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 没有问题</span></span><br><span class="line"><span class="keyword">for</span> (...) &#123;</span><br><span class="line">    CComPtr&lt;IShellFolder&gt; pDesktop;</span><br><span class="line">    SHGetDesktopFolder(&amp;pDesktop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有问题，接口没有调用Release，内存泄露</span></span><br><span class="line">CComPtr&lt;IShellFolder&gt; pDesktop;</span><br><span class="line"><span class="keyword">for</span> (...) &#123;</span><br><span class="line">    SHGetDesktopFolder(&amp;pDesktop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其根本原因是，CComPtr的&amp;操作符重载的时候没有做释放操作，只有Debug版本的assert来提醒程序员这样使用的问题。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">T** <span class="keyword">operator</span>&amp;() <span class="keyword">throw</span>()</span><br><span class="line">&#123;</span><br><span class="line">    ATLASSERT(p==<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> &amp;p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们需要手动调用Release</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">CComPtr&lt;IShellFolder&gt; pDesktop;</span><br><span class="line"><span class="keyword">for</span> (...) &#123;</span><br><span class="line">    SHGetDesktopFolder(&amp;pDesktop);</span><br><span class="line">    ......</span><br><span class="line">    pDesktop.Release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，这里是调用CComPtr的Release成员函数，而不是其保护的接口对象的Release函数。</p>
<p>另外一个解决方案就是使用&lt;comdef.h&gt;里的_com_ptr_t，这个类对于上述情况做了更加合理的处理。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">Interface** <span class="keyword">operator</span>&amp;() <span class="keyword">throw</span>()</span><br><span class="line">&#123;</span><br><span class="line">    _Release();</span><br><span class="line">    m_pInterface = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> &amp;m_pInterface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这个类里，重载&amp;操作符的函数会先调用Release，然后再取地址避免了内存泄漏的问题。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://0cch.com/2019/01/20/use-ccomptr-in-loops-requires-special-attention/" data-id="ckk4wfm0f008rh4up4ti4bqb1" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  


  <div id="page-nav">
    <nav><ul class="pagination"><li><a class="page-prev" rel="prev" href="/"><i class="fa fa-chevron-left"></i> Prev</a></li><li><a class="page-number" href="/">1</a></li><li class="active"><span class="page-number">2</span></li><li><a class="page-number" href="/page/3/">3</a></li><li><a class="page-number" href="/page/4/">4</a></li><li class="disabled"><span class="page-space">&hellip;</span></li><li><a class="page-number" href="/page/16/">16</a></li><li><a class="page-next" rel="next" href="/page/3/">Next <i class="fa fa-chevron-right"></i></a></li></ul></nav>
  </div>



        </div>
        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          
  <div class="sidebar-module sidebar-module-inset">
  <h4>About</h4>
  <p>https://github.com/0cch</p>

</div>


  
  <div class="sidebar-module">
    <h4>Categories</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/CPP/">CPP</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Debugging/">Debugging</a><span class="sidebar-module-list-count">29</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Debugging/NTInternals/">NTInternals</a><span class="sidebar-module-list-count">5</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Debugging/NTInternals/Tips/">Tips</a><span class="sidebar-module-list-count">1</span></li></ul></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Debugging/Tips/">Tips</a><span class="sidebar-module-list-count">7</span></li></ul></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/DeepLearner/">DeepLearner</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/MiniKernel/">MiniKernel</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/NTInternals/">NTInternals</a><span class="sidebar-module-list-count">22</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/NTInternals/Tips/">Tips</a><span class="sidebar-module-list-count">4</span></li></ul></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Tips/">Tips</a><span class="sidebar-module-list-count">67</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/debugging/">debugging</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/machinelearning/">machinelearning</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list" itemprop="keywords"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/File-System/" rel="tag">File System</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/IDE/" rel="tag">IDE</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Kernel/" rel="tag">Kernel</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/MiniKernel/" rel="tag">MiniKernel</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/NTFS/" rel="tag">NTFS</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/NTInternals/" rel="tag">NTInternals</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/NTSTATUS/" rel="tag">NTSTATUS</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/OS/" rel="tag">OS</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/PIO/" rel="tag">PIO</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/System/" rel="tag">System</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Test/" rel="tag">Test</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Volume/" rel="tag">Volume</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Windows/" rel="tag">Windows</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/grub/" rel="tag">grub</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/snapshot/" rel="tag">snapshot</a><span class="sidebar-module-list-count">1</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/File-System/" style="font-size: 10px;">File System</a> <a href="/tags/IDE/" style="font-size: 10px;">IDE</a> <a href="/tags/Kernel/" style="font-size: 20px;">Kernel</a> <a href="/tags/MiniKernel/" style="font-size: 10px;">MiniKernel</a> <a href="/tags/NTFS/" style="font-size: 15px;">NTFS</a> <a href="/tags/NTInternals/" style="font-size: 10px;">NTInternals</a> <a href="/tags/NTSTATUS/" style="font-size: 10px;">NTSTATUS</a> <a href="/tags/OS/" style="font-size: 10px;">OS</a> <a href="/tags/PIO/" style="font-size: 10px;">PIO</a> <a href="/tags/System/" style="font-size: 10px;">System</a> <a href="/tags/Test/" style="font-size: 10px;">Test</a> <a href="/tags/Volume/" style="font-size: 10px;">Volume</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/grub/" style="font-size: 10px;">grub</a> <a href="/tags/snapshot/" style="font-size: 10px;">snapshot</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/08/">August 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/07/">July 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/06/">June 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/05/">May 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/04/">April 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/03/">March 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/02/">February 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/01/">January 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/12/">December 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/11/">November 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/10/">October 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/09/">September 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/08/">August 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/07/">July 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/06/">June 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/05/">May 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/04/">April 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/03/">March 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/02/">February 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/01/">January 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/12/">December 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/11/">November 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/10/">October 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/09/">September 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/08/">August 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/07/">July 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/06/">June 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/03/">March 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/02/">February 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/01/">January 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/12/">December 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/11/">November 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/10/">October 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/09/">September 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/08/">August 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/07/">July 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/06/">June 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/05/">May 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/04/">April 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/03/">March 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/02/">February 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/01/">January 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/12/">December 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/11/">November 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/10/">October 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/09/">September 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/08/">August 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/07/">July 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/06/">June 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/05/">May 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/04/">April 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/03/">March 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/02/">February 2016</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/01/">January 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/12/">December 2015</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/11/">November 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/10/">October 2015</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/09/">September 2015</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/08/">August 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/07/">July 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/06/">June 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/05/">May 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/04/">April 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/03/">March 2015</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/02/">February 2015</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/01/">January 2015</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/12/">December 2014</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/11/">November 2014</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/10/">October 2014</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/09/">September 2014</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/08/">August 2014</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/07/">July 2014</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/06/">June 2014</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/05/">May 2014</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/04/">April 2014</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/03/">March 2014</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/02/">February 2014</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2014/01/">January 2014</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/12/">December 2013</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/11/">November 2013</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/10/">October 2013</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/09/">September 2013</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/08/">August 2013</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/07/">July 2013</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/06/">June 2013</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/05/">May 2013</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/04/">April 2013</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/03/">March 2013</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/02/">February 2013</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/01/">January 2013</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2012/12/">December 2012</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2012/11/">November 2012</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2012/08/">August 2012</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2012/02/">February 2012</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2011/12/">December 2011</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2011/10/">October 2011</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2011/09/">September 2011</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2011/08/">August 2011</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2011/06/">June 2011</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2011/05/">May 2011</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2011/04/">April 2011</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2011/02/">February 2011</a><span class="sidebar-module-list-count">1</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2020/08/05/something-about-enable_shared_from_this/">std::enable_shared_from_this原理浅析</a>
        </li>
      
        <li>
          <a href="/2020/07/07/use-fmtlib-format-string/">使用fmtlib格式化字符串</a>
        </li>
      
        <li>
          <a href="/2020/06/15/yampl-seq-and-iterator-part3/">序列和迭代器(3)</a>
        </li>
      
        <li>
          <a href="/2020/05/20/yampl-seq-and-iterator-part2/">序列和迭代器(2)</a>
        </li>
      
        <li>
          <a href="/2020/04/01/yampl-seq-and-iterator-part1/">序列和迭代器(1)</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2021 0CCh<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>




<script src="/js/script.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</body>
</html>
