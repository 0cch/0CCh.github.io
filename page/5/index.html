<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <link rel="icon" href="/favicon.ico">
  
  <title>0CCh Blog</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox-1.3.4.css">
  <!--在这里倒入jquery 方便处理部分页面的jquery-->
  <script src="https://cdn.staticfile.org/jquery/1.7/jquery.min.js" type="text/javascript" ></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body class="home">
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="site-header navfixed-false">
  <div class="container">
      <h1><a href="/" title="0CCh Blog"><span class="octicon octicon-mark-github"></span> 0CCh Blog</a></h1>
      <nav class="site-header-nav" role="navigation">
        
              
              <a href="/"  class=" site-header-nav-item hvr-underline-from-center" title="Home">Home</a>
        
              
              <a href="/categories/"  class=" site-header-nav-item hvr-underline-from-center" title="Category">Category</a>
        
              
              <a href="/open-source/"  class=" site-header-nav-item hvr-underline-from-center" title="Open-Source">Open-Source</a>
        
      </nav>
  </div>
</header>

	<section class="banner-false">
    <div class="collection-head">
        <div class="container">
            <div class="collection-title">
                <h1 class="collection-header" id="site-description">
                    
                </h1>
                <div class="collection-info">
                    
                    
                        <span class="meta-info">
                            
                                <span class="octicon octicon-location">
                                   
                                        China
                                    
                                </span>
                                
                            
                        </span>
                    
                        <span class="meta-info">
                            
                                <span class="octicon octicon-mark-github">
                                   
                                </span>
                                
                                    <a href="http://github.com/0cch" target="_blank">0cch</a>
                                
                            
                        </span>
                    
                </div>
            </div>
        </div>
    </div>
</section>
	   <section class="container">
    <div class="columns">
        <div class="column two-thirds">
            
                  <article id="post-e4bdbfe794a8windowse69caae4bdbfe794a8e58685e5ad98e58e9fe79086e5928ce5ba94e794a8" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2015/02/02/e4bdbfe794a8windowse69caae4bdbfe794a8e58685e5ad98e58e9fe79086e5928ce5ba94e794a8/">使用Windows未使用内存原理和应用</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><a href="/uploads/2015/02/20150202104522.png"><img src="/uploads/2015/02/20150202104522.png" alt="20150202104522"></a></p>
<p>配置4G内存，并且使用过32bit Windows系统的人都知道，虽然自己有4G的物理内存，但是Windows还是明确的告诉你，它只会用其中的3GB多，还有几百MB物理内存是用不到的，即使你开启了PAE。当然如果你用的服务器系统，那就当我没说。至于微软为啥服务端32bit系统可以用4GB以上，而限制普通客户端系统，按照Windows Internals的说法，是为了考虑驱动程序的兼容性问题。我这里想介绍的是，如何使用这些没有使用的物理内存。</p>
<p><a href="/uploads/2015/02/20150202105145.png"><img src="/uploads/2015/02/20150202105145.png" alt="20150202105145"></a></p>
<p>首先，要想使用这些内存，我们必须找到他们，但是找到他们之前，我们还得了解物理内存地址是怎么分配。物理内存地址除了要给RAM提供地址之外，还需要给设备内存提供地址。为了考虑驱动的兼容性，这些设备内存被分配到4G以内的地址上，这样一来，就会有部分RAM不得不分配到4G以外的地址上了，所以我们无法使用它们。</p>
<p><a href="/uploads/2015/02/20150202110332.png"><img src="/uploads/2015/02/20150202110332.png" alt="20150202110332"></a></p>
<p>知道了这些，我们就需要聚焦到如何访问超过4GB内存的方法上了。不过方法也很简单，就是MmMapIoSpace函数，这个函数可以访问64bit的物理内存地址，并且将其映射到我们可以访问的虚拟内存上。</p>
<p>说到这里，程序的代码仿佛就呈现在脑海了，不过等等，还忽略了一个最困难的问题！到底有存在多少RAM内存在4GB以上的地址空间呢？说这个问题最为困难，是因为你需要根据不同的情况做出不同的选择。</p>
<p><a href="/uploads/2015/02/20150202095553.png"><img src="/uploads/2015/02/20150202095553.png" alt="20150202095553"></a></p>
<p>1.主板支持通过Bios查询RAM内存分配情况，在这种情况下，我们可以调用中断来获得最真实的RAM分配表。<br>2.主板不支持通过Bios查询RAM内存分配情况，那么我们很无奈的必须采用一个简单粗暴的方法，Write &amp; Test来获得4GB以外到底有多少RAM可用。  </p>
<p>对于第二种情况，我们的做法是通过MmMapIoSpace函数，把4GB以上的物理地址逐一映射到虚拟内存中，然后写入特殊值，写入后马上读取，看是否写入成功，成功则证明RAM可用。<br>对于第一种情况，这里又要分为两个分支：<br>首先你的系统是NT6内核以下的情况，这时可以调用Ke386CallBios函数，调用中断接口。<br>而对于NT6的内核，我们需要调用新的x86BiosCall等一套函数。<br>需要调用的中断函数是0x15以及AX=E820，通过这个中断和功能号，我们就能获得SYSTEM MEMORY MAP  </p>
<p>下面附带上这个功能的使用方法<br><pre><code>INT 15 - newer BIOSes - GET SYSTEM MEMORY MAP  
   AX = E820h  
   EAX = 0000E820h  
   EDX = 534D4150h (&#39;SMAP&#39;)  
   EBX = continuation value or 00000000h to start at beginning of map  
   ECX = size of buffer for result, in bytes (should be &gt;= 20 bytes)  
   ES:DI -&gt; buffer for result (see #00581)  
Return: CF clear if successful  
    EAX = 534D4150h (&#39;SMAP&#39;)  
    ES:DI buffer filled  
    EBX = next offset from which to copy or 00000000h if all done  
    ECX = actual length returned in bytes  
   CF set on error  
    AH = error code (86h) (see #00496 at INT 15&#x2F;AH=80h)  
Notes:   originally introduced with the Phoenix BIOS v4.0, this function is  
    now supported by most newer BIOSes, since various versions of Windows  
    call it to find out about the system memory  
   a maximum of 20 bytes will be transferred at one time, even if ECX is  
    higher; some BIOSes (e.g. Award Modular BIOS v4.50PG) ignore the  
    value of ECX on entry, and always copy 20 bytes  
   some BIOSes expect the high word of EAX to be clear on entry, i.e.  
    EAX=0000E820h  
   if this function is not supported, an application should fall back  
    to AX=E802h, AX=E801h, and then AH=88h  
   the BIOS is permitted to return a nonzero continuation value in EBX  
    and indicate that the end of the list has already been reached by  
    returning with CF set on the next iteration  
   this function will return base memory and ISA&#x2F;PCI memory contiguous  
    with base memory as normal memory ranges; it will indicate  
    chipset-defined address holes which are not in use and motherboard  
    memory-mapped devices, and all occurrences of the system BIOS as  
    reserved; standard PC address ranges will not be reported  
SeeAlso: AH=C7h,AX=E801h&quot;Phoenix&quot;,AX=E881h,MEM xxxxh:xxx0h&quot;ACPI&quot;  
Format of Phoenix BIOS system memory map address range descriptor:  
Offset   Size   Description   (Table 00580)  
00h   QWORD   base address  
08h   QWORD   length in bytes  
10h   DWORD   type of address range (see #00581)  
(Table 00581)  
Values for System Memory Map address type:  
01h   memory, available to OS  
02h   reserved, not available (e.g. system ROM, memory-mapped device)  
03h   ACPI Reclaim Memory (usable by OS after reading ACPI tables)  
04h   ACPI NVS Memory (OS is required to save this memory between NVS  
    sessions)  
other   not defined yet -- treat as Reserved  
（from http:&#x2F;&#x2F;www.ctyme.com&#x2F;intr&#x2F;rb-1741.htm</code></pre></p>
<p>获得了4GB内存以上的RAM范围以后，再加上MmMapIoSpace，我们就能够访问系统没有使用的内存了。</p>
<p>说了这么多，这个有什么具体应用呢？我见过最多利用这个特性做的产品就是内存盘了。也没看到什么用的特别好的其他应用的方面，我想原因主要有三点，第一，即使获得了物理内存，最后还是映射了4GB以内的虚拟内存上，内存操作终究无法访问直接更多物理内存；第二，这部分内存没有系统统一管理，同类型的软件无法共存；第三，有4G内存赶紧快去换个64位系统吧=v=。</p>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2015-02-02T06:43:30.000Z" itemprop="datePublished">2015-02-02</time>
        </span>

        
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href='/categories/NTInternals/' title=''>NTInternals</a>
          </span>
        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
                  <article id="post-e58886e4baabssd-trime4bba3e7a081" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2015/01/31/e58886e4baabssd-trime4bba3e7a081/">分享SSD TRIM代码</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>14年的早些时候发布过<a href="/tips/2014/02/11/ssd-trime58a9fe883bde79a84e4b880e4ba9be8aeb0e5bd95.html">SSD TRIM技术的文章</a>，文章里面记录了关于TRIM技术的一些东西，其中就包括在Windows上如何使用TRIM。当然Windows 7及其更高版本的系统都是自带TRIM功能的，只有XP没有这个功能，当时我就写了个工具，在XP下进行TRIM。现在想想确实也没啥意思，就把代码分享说来吧。</p>
<p><a href="https://github.com/0cch/SSDTrim.git" target="_blank" rel="external">https://github.com/0cch/SSDTrim.git</a></p>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2015-01-31T08:13:07.000Z" itemprop="datePublished">2015-01-31</time>
        </span>

        
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href='/categories/Tips/' title=''>Tips</a>
          </span>
        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
                  <article id="post-e794a8service-tage58cbae58886e585b1e4baabe7b1bbe59e8be69c8de58aa1e7babfe7a88b" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2015/01/24/e794a8service-tage58cbae58886e585b1e4baabe7b1bbe59e8be69c8de58aa1e7babfe7a88b/">用Service Tag区分共享类型服务线程</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Windows中有一种共享类型的服务，这种服务的特点是，他们可能同时有多个不同服务运行在同一个进程内。这些服务通常都是一些dll，他们被加载到宿主进程内运行，这个宿主进程我们见到最多的就是svchost了，如下图所示：</p>
<p><a href="/uploads/2015/01/20150124220922.png"><img src="/uploads/2015/01/20150124220922.png" alt="20150124220922"></a></p>
<p>Windows这样做的好处就是尽可能的节约资源，当然不好地方就是，如果出了问题那么难以调试和定位。所以，为了更好的定位共享服务的工作线程，微软支持了一种叫做Service Tag的东西。Service Tag简单的说就是标注线程属于哪个服务的，这个是由Service Control Manager支持的。在TEB中有一个SubProcessTag字段，每当一个服务注册并且运行的时候，Service Control Manager会分配给服务线程一个id，这个id就是SubProcessTag，它能够唯一的表示服务，而且这个值是一直都被继承的，也就是说，如果服务线程再创建线程，那么新的线程的SubProcessTag也会被标记为父线程的id。当然，也有一种例外，那就是如果用了线程池，就不会继承SubProcessTag了。</p>
<p>在Advapi32.dll中有一个函数，叫做I_QueryTagInformation，这个函数可以根据SubProcessTag去查询Service的信息，有兴趣的同学可以看看下面的链接：<a href="http://wj32.org/wp/2010/03/30/howto-use-i_querytaginformation/" target="_blank" rel="external">http://wj32.org/wp/2010/03/30/howto-use-i_querytaginformation/</a></p>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2015-01-24T06:29:31.000Z" itemprop="datePublished">2015-01-24</time>
        </span>

        
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href='/categories/Debugging/' title=''>Debugging</a><a href='/categories/Debugging/Tips/' title=''>Tips</a>
          </span>
        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
                  <article id="post-e680bbe7bb93e5928ce5b195e69c9befbc9ae4b89ce696b9e4b88de4baaee8a5bfe696b9e4baae" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2015/01/11/e680bbe7bb93e5928ce5b195e69c9befbc9ae4b89ce696b9e4b88de4baaee8a5bfe696b9e4baae/">总结和展望：东方不亮西方亮</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>一转眼，一年又过去了，又到了总结过去的一年，计划新年的时候了。过去的一年里，最大的感觉是，好想经过了好多事情，但却没有经历什么事情。说起来挺绕的，慢慢来回忆下吧。</p>
<p>首先是工作上的事情，由于在前年整个部门被裁，去了一个价值观上和自己的很不同公司。事实证明，这确实不是什么好的决定，吐槽的事情就不细说了。之所以没换公司，是因为我觉得在北京待不了多久了，跳槽只会坑了其他的公司。所以也就勉强的继续干着。虽说是勉强的干活，但是工作的时间还是将近占用了每天的三分之二。工作的内容也没有什么创造性，基本上就是在可怕的代码里改来改去，当然了，也许这也是他这么可怕的原因吧。</p>
<p>多米乐骨效应，工作占用大量的时间，也导致我2014年的计划大打折扣。脚本编译器，写了一半听了下来，minikernel也没什么进展，唯一比较让人舒心的是，0CCh的山寨小工具，还是在慢慢的变多，其中还有花了大量精力写的everything_study，不过由于算法还没没达到目标效果（没有everything快，数据库也比他的大很多），所以没有放出来，也就是自己在用。确实也是因为工作的原因，没有太多时间和精力去改造文件id间相互索引的算法了。再说说健身，同样的理由，工作时间长影响身体和健身，现在25分钟基本上就跑个4.7km，13年的最后，都是能跑5km多点的。</p>
<p>不过东方不亮西方亮了，有失意的地方，总会在其他地方补回来=v=，生命中终于又多了一个人，能让我更加坚定的回老家了。所以，今年的计划特别难定，因为不知道回老家后到底是什么个情况。只能说回去之前继续坚持着，回去之后去找个心仪的事情。然后，编译器和minikernel希望能继续写，编译器希望能写玩，因为并不难。minikernel就比较复杂了，只能说能写多少写多少。另外我也特别喜欢山寨各种各样的小工具，自己造轮子自己用，赶紧挺开心的。健身方面，回去前照旧，回去后尽量保持。</p>
<p>其实生活上14年真的还算挺开心的，和sysdbg的博主一起还打完了好几个ps3的游戏。比如《神秘海域3》，《第一次世界大战——勇敢的心》等等=v=，还有他13年欠我的金钱豹还没请我吃呢…</p>
<p>最后，我还是希望2015年，我自己和家人、亲戚以及基友们，身体健康，阖家辛福快乐，工作顺利发大财！</p>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2015-01-11T06:08:30.000Z" itemprop="datePublished">2015-01-11</time>
        </span>

        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
                  <article id="post-pythone88eb7e5be97e69687e4bbb6e78988e69cace4bfa1e681af" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2014/12/21/pythone88eb7e5be97e69687e4bbb6e78988e69cace4bfa1e681af/">Python获得文件版本信息</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Python干啥都挺方便的，出了调用win32的api。当然了，可以用pywin32这种库。但我不喜欢为了一两个api又给简单的东西加一堆依赖。比如获取文件版本，本来想在网上找个函数复制过去用得了，却发现还真没啥好用的。无奈自己就写了一个。</p>
<pre><code>
class VS_FIXEDFILEINFO(Structure):
	_fields_ = [
		(&quot;dwSignature&quot;, c_int), 
		(&quot;dwStrucVersion&quot;, c_int),
		(&quot;dwFileVersionMS&quot;, c_int),
		(&quot;dwFileVersionLS&quot;, c_int),
		(&quot;dwProductVersionMS&quot;, c_int),
		(&quot;dwProductVersionLS&quot;, c_int),
		(&quot;dwFileFlagsMask&quot;, c_int),
		(&quot;dwFileFlags&quot;, c_int),
		(&quot;dwFileOS&quot;, c_int),
		(&quot;dwFileType&quot;, c_int),
		(&quot;dwFileSubtype&quot;, c_int),
		(&quot;dwFileDateMS&quot;, c_int),
		(&quot;dwFileDateLS&quot;, c_int)
	]
def LOWORD(dword): return dword &amp; 0x0000ffff
def HIWORD(dword): return dword &gt;&gt; 16
def GetFileVersion(filename):
	size = windll.version.GetFileVersionInfoSizeW(filename, None)
	if not size:
		return &#39;&#39;
	res = create_string_buffer(size)
	windll.version.GetFileVersionInfoW(filename, None, size, res)
	r = VS_FIXEDFILEINFO()
	l = c_uint()
	p = c_void_p()
	windll.version.VerQueryValueW(res, &#39;\\&#39;, byref(p), byref(l));
	memmove(byref(r), p, sizeof(VS_FIXEDFILEINFO))
	if not l.value:
		return &#39;&#39;
	
	return (&#39;%d.%d.%d.%d&#39; % (HIWORD(r.dwFileVersionMS), LOWORD(r.dwFileVersionMS), 
		HIWORD(r.dwProductVersionLS), LOWORD(r.dwProductVersionLS)));</code></pre>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2014-12-21T03:25:02.000Z" itemprop="datePublished">2014-12-21</time>
        </span>

        
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href='/categories/Tips/' title=''>Tips</a>
          </span>
        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
                  <article id="post-dnsswitcher-e4b880e4b8aae696b9e4bebfe58887e68da2dnse79a84e5b08fe5b7a5e585b7" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2014/12/14/dnsswitcher-e4b880e4b8aae696b9e4bebfe58887e68da2dnse79a84e5b08fe5b7a5e585b7/">DNSSwitcher —— 一个方便切换DNS的小工具</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>最近百度也推出的自己的公共DNS，现在可供我们选择使用的DNS也多了起来。但是每次更改DNS都输入IP，确实挺麻烦的。于是我周末在家就写了个切换DNS的小程序，绿色且易用，能在配置好的DNS直接切换，当然也能切换回自动获取DNS的模式。至于配置文件，可以手动修改，也可以通过程序来修改，都挺方便的。</p>
<p><a href="/uploads/2014/12/20141214190237.png"><img src="/uploads/2014/12/20141214190237.png" alt="20141214190237"></a></p>
<p>配置文件格式如<br>[Google DNS]<br>dns1=8.8.8.8<br>dns2=8.8.4.4<br>[Open DNS]<br>dns1=208.67.222.222<br>dns2=208.67.220.220<br>…  </p>
<p>下载：<a href="/uploads/2014/12/DNSSwitcher.zip">DNSSwitcher</a></p>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2014-12-14T03:07:07.000Z" itemprop="datePublished">2014-12-14</time>
        </span>

        
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href='/categories/Tips/' title=''>Tips</a>
          </span>
        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
                  <article id="post-tcpview_study-e69fa5e79c8btcpe8bf9ee68ea5e5b7a5e585b7" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2014/12/07/tcpview_study-e69fa5e79c8btcpe8bf9ee68ea5e5b7a5e585b7/">tcpview_study——查看TCP连接工具</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>tcpview_study是一款监控TCP连接的小工具，实际上功能就是山寨的sysinternals工具集的tcpview，功能也差不多，主要是没事拿来练练手。</p>
<p><a href="/uploads/2014/12/20141207175522.png"><img src="/uploads/2014/12/20141207175522.png" alt="20141207175522"></a></p>
<p>下载：<a href="/uploads/2014/12/tcpview_study.zip">tcpview_study</a></p>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2014-12-07T01:58:47.000Z" itemprop="datePublished">2014-12-07</time>
        </span>

        
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href='/categories/Tips/' title=''>Tips</a>
          </span>
        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
                  <article id="post-e88eb7e5be97e4bdbfe794a8e68993e5bc80e4bf9de5ad98e5afb9e8af9de6a186e6938de4bd9ce69687e4bbb6e79a84e8aeb0e5bd95" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2014/11/17/e88eb7e5be97e4bdbfe794a8e68993e5bc80e4bf9de5ad98e5afb9e8af9de6a186e6938de4bd9ce69687e4bbb6e79a84e8aeb0e5bd95/">获得使用打开保存对话框操作文件的记录</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>今天无意中看到了HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\OpenSavePidlMRU这个键值的用途，虽然感觉没啥实际用途，但是也挺有趣的，于是写了个小程序读取它。这个键值的意义非常明确，就是记录打开保存对话框的最近操作的文件的PIDL。所以我们可以通过PIDL来获得文件路径，就这么简单，确实没啥特别的实际用途吧，就当娱乐了。枚举的效果如下：</p>
<p><a href="/uploads/2014/11/20141117231005.png"><img src="/uploads/2014/11/20141117231005.png" alt="20141117231005"></a></p>
<p>代码也很简单：</p>
<pre><code>
#include &quot;stdafx.h&quot;
#include &lt;atlbase.h&gt;
#include &lt;atlstr.h&gt;
#include &lt;Shlobj.h&gt;
#include &lt;locale.h&gt;
#include &lt;vector&gt;

#pragma comment(lib, &quot;shell32.lib&quot;)

const TCHAR mru_path[] = TEXT(&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ComDlg32\\OpenSavePidlMRU&quot;);

void EnumMRUValue(HKEY subkey, std::vector &amp;mru;_files)
{
	ULONG i = 0, j = 0;
	TCHAR value_name[MAX_PATH];
	ULONG value_name_length = MAX_PATH;
	UCHAR data_buffer[1024];
	ULONG data_length = sizeof(data_buffer);
	while (RegEnumValue(subkey, i++, value_name, &amp;value;_name_length, 0, NULL, data_buffer, &amp;data;_length) == ERROR_SUCCESS)
	{
		if (_tcscmp(value_name, TEXT(&quot;MRUListEx&quot;)) != 0) {
			CComPtr malloc_ptr;
			HRESULT hr = SHGetMalloc(&amp;malloc;_ptr);
			LPITEMIDLIST file_pidl = (LPITEMIDLIST)malloc_ptr-&gt;Alloc(sizeof(UCHAR) + data_length);

			if (file_pidl) {
				memcpy(file_pidl, data_buffer, data_length);
				WCHAR file_path[MAX_PATH] = { 0 };
				if (SHGetPathFromIDList(file_pidl, file_path)) {
					mru_files.push_back(file_path);
					
				}
				malloc_ptr-&gt;Free(file_pidl);
			}
		}

		value_name_length = MAX_PATH;
		data_length = sizeof(data_buffer);
	}
}

BOOL PrintMRUFiles()
{
	HKEY subkey;
	LSTATUS l = RegOpenKeyEx(HKEY_CURRENT_USER, mru_path, 0, KEY_READ, &amp;subkey;);
	if (l != ERROR_SUCCESS) {
		return FALSE;
	}
	ULONG i = 0;
	TCHAR key_name[MAX_PATH];
	ULONG key_name_length = MAX_PATH;
	while (RegEnumKeyEx(subkey, i++, key_name, &amp;key;_name_length, 0, NULL, NULL, NULL) == ERROR_SUCCESS)
	{
		HKEY ext_key;
		LSTATUS l = RegOpenKeyEx(subkey, key_name, 0, KEY_READ, &amp;ext;_key);
		if (l == ERROR_SUCCESS) {
			
			std::vector mru_files;
			EnumMRUValue(ext_key, mru_files);
			if (mru_files.size() &gt; 0) {
				_tprintf(TEXT(&quot;Extension Name : %s\n&quot;), key_name);
				ULONG j = 0;
				for (std::vector::iterator it = mru_files.begin(); it != mru_files.end(); ++it) {

					WIN32_FILE_ATTRIBUTE_DATA attribute_data = { 0 };
					
					if (GetFileAttributesEx(it-&gt;GetString(), GetFileExInfoStandard, &amp;attribute;_data)) {
						ULONGLONG file_size = ((ULONGLONG)attribute_data.nFileSizeHigh) &lt;&lt; 32 | attribute_data.nFileSizeLow;
						_tprintf(TEXT(&quot;\t %u %s  % 11I64u KB] %s\n&quot;), j++,
							(attribute_data.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY) == 0 ? TEXT(&quot;[FILE&quot;) : TEXT(&quot;[DIR &quot;),
							(file_size + 1023) &#x2F; 1024,
							it-&gt;GetString());
					}
					else {
						_tprintf(TEXT(&quot;\t %u [ERROR_FILE_NOT_FOUND] %s\n&quot;), j++,
							it-&gt;GetString());
					}
					
				}
			}
			
			RegCloseKey(ext_key);
		}

		key_name_length = MAX_PATH;
	}
	
	RegCloseKey(subkey);
	return TRUE;
}


int _tmain(int argc, _TCHAR* argv[])
{
	setlocale(LC_ALL, &quot;chs&quot;);
	PrintMRUFiles();
	return 0;
}


 </code></pre>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2014-11-17T07:32:46.000Z" itemprop="datePublished">2014-11-17</time>
        </span>

        
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href='/categories/Tips/' title=''>Tips</a>
          </span>
        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
                  <article id="post-e4b8bbe7babfe7a88be98080e587bae5898de8afb7e58588e98080e587bae5ad90e7babfe7a88b" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2014/11/10/e4b8bbe7babfe7a88be98080e587bae5898de8afb7e58588e98080e587bae5ad90e7babfe7a88b/">主线程退出前请先退出子线程</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>我们知道理论上如果一个进程的主线程退出，整个进程就会销毁，子线程自然也是要退出的。但是这并不意味着，程序退出的时候我们就能不问不管自己创建的子线程，因为不管他还真有可能出问题。下面是一个典型的主线程退出过程中，而子线程未退出，造成死锁整个进程的分析图，死锁在c runtime里，死锁原因看图便知，也不用太多解释了。</p>
<p><a href="/uploads/2014/11/20141106094954.png"><img src="/uploads/2014/11/20141106094954.png" alt="20141106094954"></a></p>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2014-11-09T19:13:31.000Z" itemprop="datePublished">2014-11-10</time>
        </span>

        
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href='/categories/Tips/' title=''>Tips</a>
          </span>
        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
                  <article id="post-clipmonitor-e7ae80e58d95e79a84e589aae58887e69dbfe79b91e68ea7e5b7a5e585b7" class="repo-list">
    <div class="repo-list-item" >
      <h3 class="repo-list-name" itemprop="name">
        
  
      <a class="article-title" href="/2014/11/02/clipmonitor-e7ae80e58d95e79a84e589aae58887e69dbfe79b91e68ea7e5b7a5e585b7/">ClipMonitor 简单的剪切板监控工具</a>
  

      </h3>
      <div class="repo-list-description">
        
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>周末花了点时间写了个剪切板监控工具，他会记录剪切板里面的数据，并且支持用HEX和TEXT对数据进行分析。<br>涉及到的技术很简单，网上已经有一堆了，没什么可说的，我这里主要是加入了HEX的模块，方便对未知的剪切板数据进行分析而已。</p>
<p><a href="/uploads/2014/11/20141102204618.png"><img src="/uploads/2014/11/20141102204618.png" alt="20141102204618"></a></p>
<p><a href="/uploads/2014/11/20141102204638.png"><img src="/uploads/2014/11/20141102204638.png" alt="20141102204638"></a></p>
<p><a href="/uploads/2014/11/20141102204651.png"><img src="/uploads/2014/11/20141102204651.png" alt="20141102204651"></a></p>
<p>下载：<a href="/uploads/2014/11/ClipMonitor.zip">ClipMonitor</a></p>

        
      </div>
      <p class="repo-list-meta">
        <span class="meta-info">
          <span class="octicon octicon-calendar"></span>
           <time datetime="2014-11-02T04:55:57.000Z" itemprop="datePublished">2014-11-02</time>
        </span>

        
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href='/categories/Tips/' title=''>Tips</a>
          </span>
        
      
        <!--
          
        -->

      </p>
    </div>
  </article>
            
        </div>
        <div class="column one-third">
          <!--处理未安装 search 插件 默认 Google 搜索-->
 

<h3>Search</h3>

<div id="site_search">

	<!-- Google -->
	
		<form action="http://www.google.com/search?" data-site="http://0cch.com">
	    	<input type="text" id="search_box" name="q" placeholder="Search">
	    	<button type="button" class="btn btn-default" id="site_search_do"><span class="octicon octicon-search"></span></button>
	    </form>
	

	<!-- 本地搜索 -->
	

</div>

<h3>Popular Repositories</h3>
    <div class="popular-container"></div>
    
    <script type="text/template" id="popular-list-template">
        <a href="{%=clone_url%}" class="card text-center" target="_blank">
            <div class="thumbnail">
                <div class="card-image geopattern" data-pattern-id="{%=name%}">
                    <div class="card-image-cell">
                        <h3 class="card-title">
                            {%=name%}
                        </h3>
                    </div>
                </div>
                <div class="caption">
                    <div class="card-description">
                        <p class="card-text">
                            {%=description%}
                        </p>
                    </div>
                    <div class="card-text">
                        <span class="meta-info tooltipped tooltipped-n" aria-label="{%=stargazers_count%} stars">
                            <span class="octicon octicon-star"></span> {%=stargazers_count%}
                        </span>
                        <span class="meta-info tooltipped tooltipped-n" aria-label="{%=forks_count%} forks">
                            <span class="octicon octicon-git-branch"></span> {%=forks_count%}
                        </span>
                        <span class="meta-info tooltipped tooltipped-n" aria-label="最后更新时间：{%=updated_at%}">
                            <span class="octicon octicon-clock"></span>
                            <time datetime="{%=updated_at%}">{%=updated_at%}</time>
                        </span>
                    </div>
                </div>
            </div>
        </a>
    </script>

    <script src="/js/baiduTemplate.js"></script>
    <script type="text/javascript">
        var popular_repos = function(){

            var baiduTpl = new Object();

            var handleTpl = function(){
                baiduTpl.popular_list = baidu.template("popular-list-template");
            };

            var handleGithub = function(){
                var popularContainer = $(".popular-container");

                var repos = "0cchext,luadbg".split(",");
                for(var i in repos){
                    var name = repos[i];
                    $.get("https://api.github.com/repos/0cch/"+name,handle);
                }

                function handle(result){
                    result.updated_at = result.updated_at.split("T")[0];
                    if(result){
                        var html = baiduTpl.popular_list(result);
                        popularContainer.append(html);
                        $(".geopattern").each(function(){           
                            $(this).geopattern($(this).data('pattern-id'));
                        });
                    }
                }
            };

            return {
                init:function(){
                    handleTpl();
                    handleGithub();
                }
            }
        }; 
        $(popular_repos().init);
    </script>

        </div>
    </div>

    
      <div class="pagination text-align">
          <div class="btn-group">
              <a class="extend prev" rel="prev" href="/page/4/">&laquo;</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/6/">&raquo;</a>
          </div>
      </div>
    
</section>

<footer class="container">
    <div class="site-footer" role="contentinfo">
        
        <ul class="site-footer-links right mobile-hidden">
            <li>
                <a href="javascript:window.scrollTo(0,0)" >TOP</a>
            </li>
        </ul>

        <ul class="site-footer-links mobile-hidden">
            
                  
                  <li>
                    <a href="/"  title="Home">Home</a>
                  </li>
            
                  
                  <li>
                    <a href="/categories/"  title="Category">Category</a>
                  </li>
            
                  
                  <li>
                    <a href="/open-source/"  title="Open-Source">Open-Source</a>
                  </li>
            
            <li>
                <a href="/atom.xml">
                    <span class="octicon octicon-rss" style="color:orange;"></span>
                </a>
            </li>
        </ul>
    </div>
</footer>

		<script src="/js/geopattern.js"></script>
		<script src="/js/highlight.pack.js"></script>
		<script src="/lib/fancybox/jquery.fancybox-1.3.4.pack.js"></script>

		

		<script src="/js/index.js"></script>

		 <script src="/js/popular_repo.js"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end --> 

	</body>
</html>