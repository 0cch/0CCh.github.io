<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
  <meta charset="utf-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <link rel="icon" href="/favicon.ico">
  
  <title>0CCh Blog | 验证文件签名</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox-1.3.4.css">
  <!--在这里倒入jquery 方便处理部分页面的jquery-->
  <script src="https://cdn.staticfile.org/jquery/1.7/jquery.min.js" type="text/javascript" ></script>
</head>

<body>
	<header class="site-header navfixed-false">
  <div class="container">
      <h1><a href="/" title="0CCh Blog"><span class="octicon octicon-mark-github"></span> 0CCh Blog</a></h1>
      <nav class="site-header-nav" role="navigation">
        
              
              <a href="/"  class=" site-header-nav-item hvr-underline-from-center" title="Home">Home</a>
        
              
              <a href="/categories/"  class=" site-header-nav-item hvr-underline-from-center" title="Category">Category</a>
        
              
              <a href="/open-source/"  class=" site-header-nav-item hvr-underline-from-center" title="Open-Source">Open-Source</a>
        
              
              <a href="/message/"  class=" site-header-nav-item hvr-underline-from-center" title="Message">Message</a>
        
      </nav>
  </div>
</header>

	
<section class="collection-head geopattern" data-pattern-id="验证文件签名" >
    <div class="container">
        <div class="collection-title">
            <h1 class="collection-header">
                验证文件签名
            </h1>
            
                <div class="collection-info">
                    <span class="meta-info">
                        <span class="octicon octicon-calendar"></span>
                        <time datetime="2016-09-21T04:22:50.000Z" itemprop="datePublished">2016-09-21</time>
                    </span>
                    
                        <span class="meta-info">
                            <span class="octicon octicon-file-directory"></span>
                            <a href='/categories/Tips/' title=''>Tips</a>
                        </span>
                    
                </div>
            
        </div>
    </div>
</section>
	<section class="container">
    <div class="columns">
        <div class="column  three-fourths " >
            <article class="article-content markdown-body">
                <p>Sysinternal(<a href="http://forum.sysinternals.com/howto-verify-the-digital-signature-of-a-file_topic19247.html)上有关于验证签名的代码，不过代码有点问题，他只能验证PE签名，无法验证文件签名，所以我这里稍作了点修改，记录一下" target="_blank" rel="external">http://forum.sysinternals.com/howto-verify-the-digital-signature-of-a-file_topic19247.html)上有关于验证签名的代码，不过代码有点问题，他只能验证PE签名，无法验证文件签名，所以我这里稍作了点修改，记录一下</a></p>
<pre><code>
#define ENCODING (X509_ASN_ENCODING | PKCS_7_ASN_ENCODING)

BOOL CheckFileTrust(LPCTSTR filename, CString &amp;signer_file)
{
	HCATADMIN cat_admin_handle = NULL;
	if (!CryptCATAdminAcquireContext(&amp;cat_admin_handle, NULL, 0))
	{
		return FALSE;
	}

	HANDLE hFile = CreateFileW(filename, GENERIC_READ, FILE_SHARE_READ,
		NULL, OPEN_EXISTING, 0, NULL);
	if (INVALID_HANDLE_VALUE == hFile)
	{
		CryptCATAdminReleaseContext(cat_admin_handle, 0);
		return FALSE;
	}

	DWORD hash_count = 100;
	BYTE hash_data[100];
	CryptCATAdminCalcHashFromFileHandle(hFile, &amp;hash_count, hash_data, 0);
	CloseHandle(hFile);

	LPWSTR member_tag = new WCHAR[hash_count * 2 + 1];
	for (DWORD dw = 0; dw &lt; hash_count; ++dw)
	{
		wsprintfW(&amp;member_tag[dw * 2], L&quot;%02X&quot;, hash_data[dw]);
	}

	WINTRUST_DATA wd = { 0 };
	WINTRUST_FILE_INFO wfi = { 0 };
	WINTRUST_CATALOG_INFO wci = { 0 };
	CATALOG_INFO ci = { 0 };
	HCATINFO cat_admin_info = CryptCATAdminEnumCatalogFromHash(cat_admin_handle,
		hash_data, hash_count, 0, NULL);
	if (NULL == cat_admin_info)
	{
		wfi.cbStruct = sizeof(WINTRUST_FILE_INFO);
		wfi.pcwszFilePath = filename;
		wfi.hFile = NULL;
		wfi.pgKnownSubject = NULL;

		wd.cbStruct = sizeof(WINTRUST_DATA);
		wd.dwUnionChoice = WTD_CHOICE_FILE;
		wd.pFile = &amp;wfi;
		wd.dwUIChoice = WTD_UI_NONE;
		wd.fdwRevocationChecks = WTD_REVOKE_NONE;
		wd.dwStateAction = WTD_STATEACTION_IGNORE;
		wd.dwProvFlags = WTD_SAFER_FLAG;
		wd.hWVTStateData = NULL;
		wd.pwszURLReference = NULL;
		signer_file = filename;
	}
	else
	{
		CryptCATCatalogInfoFromContext(cat_admin_info, &amp;ci, 0);
		wci.cbStruct = sizeof(WINTRUST_CATALOG_INFO);
		wci.pcwszCatalogFilePath = ci.wszCatalogFile;
		wci.pcwszMemberFilePath = filename;
		wci.pcwszMemberTag = member_tag;
		wci.pbCalculatedFileHash = hash_data;
		wci.cbCalculatedFileHash = hash_count;

		wd.cbStruct = sizeof(WINTRUST_DATA);
		wd.dwUnionChoice = WTD_CHOICE_CATALOG;
		wd.pCatalog = &amp;wci;
		wd.dwUIChoice = WTD_UI_NONE;
		wd.fdwRevocationChecks = WTD_REVOKE_WHOLECHAIN;
		wd.dwProvFlags = 0;
		wd.hWVTStateData = NULL;
		wd.pwszURLReference = NULL;
		signer_file = ci.wszCatalogFile;
	}
	GUID action = WINTRUST_ACTION_GENERIC_VERIFY_V2;
	HRESULT hr = WinVerifyTrust(NULL, &amp;action, &amp;wd);
	BOOL retval = SUCCEEDED(hr);

	if (NULL != cat_admin_info) {
		CryptCATAdminReleaseCatalogContext(cat_admin_handle, cat_admin_info, 0);
	}
	CryptCATAdminReleaseContext(cat_admin_handle, 0);
	delete[] member_tag;
	return retval;
}

BOOL GetCertificateInfo(PCCERT_CONTEXT cert_context, CString &amp;signer_name)
{
	LPTSTR name = NULL;
	DWORD data;

	if (!(data = CertGetNameString(cert_context,
		CERT_NAME_SIMPLE_DISPLAY_TYPE,
		0,
		NULL,
		NULL,
		0))) {
			return FALSE;
	}

	&#x2F;&#x2F; Allocate memory for subject name.
	name = (LPTSTR)LocalAlloc(LPTR, data * sizeof(TCHAR));
	if (!name) {
		return FALSE;
	}

	&#x2F;&#x2F; Get subject name.
	if (!(CertGetNameString(cert_context,
		CERT_NAME_SIMPLE_DISPLAY_TYPE,
		0,
		NULL,
		name,
		data))) {

			LocalFree(name);
			return FALSE;
	}
	signer_name = name;
	LocalFree(name);
	return TRUE;
}


BOOL GetFileSigner(LPCTSTR szFileName, CString &amp;signer_name)
{
	HCERTSTORE store_handle = NULL;
	HCRYPTMSG msg_handle = NULL;
	PCCERT_CONTEXT cert_context = NULL;
	BOOL retval = FALSE;
	DWORD encoding, content_type, format_type;
	PCMSG_SIGNER_INFO signer_info = NULL;
	DWORD signer_info_size;
	CERT_INFO cert_info;
	do
	{
		&#x2F;&#x2F; Get message handle and store handle from the signed file.
		retval = CryptQueryObject(CERT_QUERY_OBJECT_FILE,
			szFileName,
			CERT_QUERY_CONTENT_FLAG_PKCS7_SIGNED_EMBED,
			CERT_QUERY_FORMAT_FLAG_BINARY,
			0,
			&amp;encoding,
			&amp;content_type,
			&amp;format_type,
			&amp;store_handle,
			&amp;msg_handle,
			NULL);
		if (!retval) {
			break;
		}

		&#x2F;&#x2F; Get signer information size.
		retval = CryptMsgGetParam(msg_handle,
			CMSG_SIGNER_INFO_PARAM,
			0,
			NULL,
			&amp;signer_info_size);
		if (!retval) {
			break;
		}

		&#x2F;&#x2F; Allocate memory for signer information.
		signer_info = (PCMSG_SIGNER_INFO)LocalAlloc(LPTR, signer_info_size);
		if (!signer_info) {
			break;
		}

		&#x2F;&#x2F; Get Signer Information.
		retval = CryptMsgGetParam(msg_handle,
			CMSG_SIGNER_INFO_PARAM,
			0,
			(PVOID)signer_info,
			&amp;signer_info_size);
		if (!retval) {
			break;
		}


		&#x2F;&#x2F; Search for the signer certificate in the temporary 
		&#x2F;&#x2F; certificate store.
		cert_info.Issuer = signer_info-&gt;Issuer;
		cert_info.SerialNumber = signer_info-&gt;SerialNumber;

		cert_context = CertFindCertificateInStore(store_handle,
			ENCODING,
			0,
			CERT_FIND_SUBJECT_CERT,
			(PVOID)&amp;cert_info,
			NULL);
		if (!cert_context) {
			break;
		}

		retval = GetCertificateInfo(cert_context, signer_name);

	} while (0);

	if (signer_info != NULL) { 
		LocalFree(signer_info); 
	}
	if (cert_context != NULL) {
		CertFreeCertificateContext(cert_context);
	}
	if (store_handle != NULL) {
		CertCloseStore(store_handle, 0);
	}
	if (msg_handle != NULL) {
		CryptMsgClose(msg_handle);
	}

	return retval;
}
</code></pre>
            </article>
            
                <div class="share">
                    <!--开启分享-->
<div class="share-component" data-disabled="google,twitter,facebook" data-description=""></div>

<script src="/js/share.min.js"></script>

                </div>    
            

            
            
                
<div class="comments">
    <div id="container"></div>
        <script src="/js/gitment.browser.js"></script>
         <script>
            var gitment = new Gitment({
                id: '/2016/09/21/verify-cert/',
                owner: '0cch',
                repo: '0CCh.github.io',
                oauth: {
                    client_id: "671c226461f366904767",
                    client_secret: "bc9407ce0e7a28726ea7b01c1e64a40e99857329",
                }
            })
        gitment.render('container')
        </script>
</div>

            

        </div>
        <div class="column one-fourth">
            
                
                


<h3>Post Directory</h3>

<div id="post-directory-module">
	<section class="post-directory">
		<p><strong class="toc-title">文章目录</strong></p>
		
	</section>
</div>
            
        </div>
    </div>
</section>

<footer class="container">
    <div class="site-footer" role="contentinfo">
        <div class="copyright left mobile-block">
                © 2016
                <span title="yumemor">yumemor</span>
                <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
        </div>

        <ul class="site-footer-links right mobile-hidden">
            <li>
                <a href="javascript:window.scrollTo(0,0)" >TOP</a>
            </li>
        </ul>

        <a href="https://github.com/yumemor/hexo-theme-primer" target="_blank" aria-label="view source code">
            <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
        </a>

        <ul class="site-footer-links mobile-hidden">
            
                  
                  <li>
                    <a href="/"  title="Home">Home</a>
                  </li>
            
                  
                  <li>
                    <a href="/categories/"  title="Category">Category</a>
                  </li>
            
                  
                  <li>
                    <a href="/open-source/"  title="Open-Source">Open-Source</a>
                  </li>
            
                  
                  <li>
                    <a href="/message/"  title="Message">Message</a>
                  </li>
            
            <li>
                <a href="/atom.xml">
                    <span class="octicon octicon-rss" style="color:orange;"></span>
                </a>
            </li>
        </ul>
    </div>
</footer>

		<script src="/js/geopattern.js"></script>
		<script src="/js/highlight.pack.js"></script>
		<script src="/lib/fancybox/jquery.fancybox-1.3.4.pack.js"></script>

		
			<script src="/js/toc.js"></script>
		

		<script src="/js/index.js"></script>

		 <script src="/js/popular_repo.js"></script> 

	</body>
</html>